<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Cacamochi â€” Deluxe+ Anim</title>
<style>
  :root{
    --rose:#f7e4e1; --rose-2:#f3d5cf; --rose-3:#eec0b6;
    --marron:#7b5644; --marron-2:#5b3d31; --txt:#2a1d16;
    --glass:#ffffffd8; --shadow:#00000028;
    --track:#e9d8d3; --fill-good:#8fd09b; --fill-mid:#f2b088; --fill-bad:#e27d7d;
    --btn:#ffe7e2; --btnOn:#ffd2c7;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--rose);color:var(--txt);
    font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  .app{min-height:100%;display:grid;grid-template-rows:auto 1fr}

  /* Header */
  header{display:flex;align-items:center;gap:.7rem;padding:.7rem .9rem;
    background:linear-gradient(180deg,var(--rose-2),var(--rose))}
  .brand img{height:32px;width:auto;display:block}
  .age{margin-left:auto;background:var(--glass);backdrop-filter:blur(6px);
    padding:.25rem .6rem;border-radius:999px;box-shadow:0 2px 6px var(--shadow);
    font-weight:800;font-size:.85rem;color:var(--marron)}

  /* Stage */
  .stage{position:relative;overflow:hidden}
  .bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .center{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;z-index:2}
  .sprite{width:clamp(180px,48vw,340px);pointer-events:auto;filter:drop-shadow(0 16px 12px var(--shadow))}
  .wobble{animation:wobble 2.4s ease-in-out infinite}
  @keyframes wobble{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-3%) scale(1.02)}}
  .wash{animation:wash .7s ease-in-out 3}@keyframes wash{0%{filter:hue-rotate(0)}50%{filter:hue-rotate(90deg) saturate(1.2)}100%{filter:hue-rotate(0)}}
  .dance{animation:dance .7s ease-in-out 4}@keyframes dance{0%{transform:translateX(0) rotate(0)}25%{transform:translateX(-8%) rotate(-6deg)}50%{transform:translateX(0)}75%{transform:translateX(8%) rotate(6deg)}100%{transform:translateX(0)}}
  /* Jouer wiggle */
  .playshake{animation:playshake .8s cubic-bezier(.2,.8,.2,1)}@keyframes playshake{
    0%{transform:rotate(0) scale(1)}20%{transform:rotate(-9deg) scale(1.06)}40%{transform:rotate(7deg)}
    60%{transform:rotate(-5deg)}80%{transform:rotate(3deg)}100%{transform:rotate(0) scale(1)}
  }

  /* HUD */
  .hud{position:absolute;top:.6rem;left:50%;transform:translateX(-50%);
    width:min(94vw,560px);display:grid;grid-template-columns:1fr 1fr;gap:.6rem;
    background:var(--glass);backdrop-filter:blur(8px);padding:.7rem;border-radius:18px;
    box-shadow:0 6px 22px var(--shadow);z-index:5}
  .bar h3{margin:0 0 .28rem;font-size:.92rem;color:var(--marron)}
  .meter{height:12px;background:var(--track);border-radius:99px;overflow:hidden}
  .meter>i{display:block;height:100%;width:50%;background:var(--fill-good);transition:width .26s}
  .bad>i{background:var(--fill-bad)} .mid>i{background:var(--fill-mid)}
  .chips{position:absolute;top:calc(.6rem + 108px);left:50%;transform:translateX(-50%);display:flex;gap:.45rem;flex-wrap:wrap;max-width:94vw;justify-content:center;z-index:5}
  .chip{background:var(--glass);backdrop-filter:blur(6px);padding:.35rem .7rem;border-radius:999px;font-size:.86rem;font-weight:800;color:var(--marron);box-shadow:0 2px 6px var(--shadow)}

  /* Sleep overlay */
  .sleepOverlay{position:absolute;inset:0;pointer-events:none;opacity:0;transition:opacity .35s;z-index:3}
  .sleeping .sleepOverlay{opacity:1}
  .sleepOverlay .tint{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 60%,#143a6a33 0,#0822458a 60%,#061a3666 100%)}
  .stars{position:absolute;inset:0;overflow:hidden}
  .star{position:absolute;width:3px;height:3px;background:#d8e7ff;border-radius:50%;opacity:.9;animation:tw 2.2s ease-in-out infinite}
  @keyframes tw{0%,100%{transform:scale(1)}50%{transform:scale(1.6)}}
  .zzz{position:absolute;left:50%;top:38%;transform:translateX(-50%);font:800 18px/1.2 system-ui;color:#cfe3ff;animation:zzz 2.6s ease-in-out infinite}
  @keyframes zzz{0%{opacity:0;transform:translate(-50%,6px)}25%{opacity:1}100%{opacity:0;transform:translate(-50%,-18px)}}

  /* Speech bubble */
  .speech{position:absolute;left:50%;top:22%;transform:translateX(-50%);z-index:6;pointer-events:none}
  .speech .b{background:var(--glass);backdrop-filter:blur(8px);padding:.5rem .7rem;border-radius:14px;box-shadow:0 6px 18px var(--shadow);font-weight:800;color:var(--marron)}
  .speech .t{width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:10px solid var(--glass);margin:auto}

  /* Disco + Sun overlay */
  #disco{position:absolute;inset:0;pointer-events:none;opacity:0;transition:opacity .2s;z-index:4}
  #disco::before,#disco::after{content:"";position:absolute;inset:-30%;background:
      radial-gradient(circle at 20% 30%, #ff9cf780 0, transparent 35%),
      radial-gradient(circle at 80% 60%, #7ae7ff80 0, transparent 35%),
      radial-gradient(circle at 50% 80%, #ffe77080 0, transparent 35%);filter:blur(12px);mix-blend-mode:screen;animation:spin 6s linear infinite}
  #disco::after{animation-direction:reverse;opacity:.8}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  .disco-on #disco{opacity:.9}

  .sunBoost{position:absolute;inset:0;pointer-events:none;opacity:0;transition:opacity .25s;z-index:4}
  .sunBoost.on{opacity:.75}
  .sunBoost:before{content:"";position:absolute;inset:-20%;background:
    radial-gradient(circle at 70% 10%, #fff0a8aa 0, transparent 35%),
    radial-gradient(circle at 10% 30%, #ffd27faa 0, transparent 35%),
    radial-gradient(circle at 50% 80%, #ffe7a1aa 0, transparent 35%);
    filter:blur(12px);mix-blend-mode:screen;animation:spin 9s linear infinite}
  /* halo autour de la plante pendant le boost */
  .plant.boost svg{filter:drop-shadow(0 0 10px #ffd86a) drop-shadow(0 0 18px #ffd86a80)}

  /* Dock (safe-area) */
  .dockWrap{
    position:absolute; left:0; right:0;
    bottom:calc(1rem + env(safe-area-inset-bottom, 0px));
    z-index:10; padding:0 .7rem;
    overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none;
    mask-image:linear-gradient(90deg,transparent 0,#000 20px,#000 calc(100% - 20px),transparent 100%)
  }
  .dockWrap::-webkit-scrollbar{display:none}
  .dock{display:flex;gap:.55rem;min-width:max-content;scroll-snap-type:x mandatory}
  .btn{scroll-snap-align:center;width:70px;height:70px;border-radius:18px;border:none;background:var(--btn);box-shadow:0 8px 18px var(--shadow);display:flex;flex-direction:column;align-items:center;justify-content:center;touch-action:manipulation}
  .btn:active{transform:translateY(2px);background:var(--btnOn)}
  .ico{width:22px;height:22px;display:block;object-fit:contain}
  .lbl{margin-top:4px;font-size:.72rem;font-weight:800;color:var(--marron)}

  /* Scene buttons */
  .gameBtn{position:absolute;z-index:8;width:62px;height:62px;border-radius:50%;border:none;background:var(--btn);box-shadow:0 8px 18px var(--shadow);display:flex;flex-direction:column;align-items:center;justify-content:center}
  .gameBtn .ico{width:22px;height:22px} .gameBtn .lbl{font-size:.7rem;margin-top:2px;color:var(--marron)}
  .gameBtn.flies{left:.8rem;top:48%} .gameBtn.bath{right:.8rem;top:48%}

  /* Plant (SVG) */
  .plant{position:absolute;right:14px;bottom:calc(120px + env(safe-area-inset-bottom, 0px));z-index:12;opacity:.98;transform-origin:50% 100%}
  .plant svg{width:76px;height:auto;display:block;filter:drop-shadow(0 6px 8px #0002)}
  .plant .sway{transform-origin:38px 64px;animation:plantSway 4.5s ease-in-out infinite}
  @keyframes plantSway{0%,100%{transform:rotate(0)}50%{transform:rotate(2.8deg)}}
  .plant.grow{animation:grow 0.6s ease-out}@keyframes grow{from{transform:scale(.9)}to{transform:scale(1)}}
  .leafWiggle{animation:leafW 1.2s ease-in-out}@keyframes leafW{0%{transform:rotate(0)}30%{transform:rotate(-8deg)}60%{transform:rotate(6deg)}100%{transform:rotate(0)}}

  /* Particules */
  .p{position:absolute;width:10px;height:10px;border-radius:50%;pointer-events:none;opacity:.9;animation:pop .8s ease-out forwards}
  @keyframes pop{0%{transform:translate(0,0) scale(.6)}100%{transform:var(--tr) scale(1);opacity:0}}

  /* Modals + games */
  .modal{position:absolute;inset:0;background:#0007;display:none;align-items:center;justify-content:center;z-index:20}
  .modal.on{display:flex}
  .panelMG{width:min(520px,92vw);height:min(420px,80vh);background:#fff6f4;border-radius:16px;box-shadow:0 10px 30px #0006;position:relative;overflow:hidden;border:3px solid var(--rose-3)}
  .panelHead{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;gap:8px}
  .panelHead h2{margin:0;font-size:16px;color:var(--marron)}
  .panelHead .info{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--marron)}
  .timer,.score{padding:.15rem .5rem;border-radius:8px;background:#ffffffb8;box-shadow:0 1px 4px #0001;min-width:36px;text-align:center}
  .close{border:none;background:#0000;font-size:18px;line-height:1;cursor:pointer;color:var(--marron)}
  .arena{position:absolute;inset:56px 12px 14px 12px;border-radius:12px;overflow:hidden}
  .arena.bath{background:#f6eaf0} .arena.flygame{background:#eaf7e6}

  /* Flies & SFX */
  .fly{position:absolute;width:38px;height:30px;transform:translate(-50%,-50%);will-change:transform}
  .fly.big{width:46px;height:36px} .fly.gold{width:40px;height:30px}
  .sfx{position:absolute;transform:translate(-50%,-50%);pointer-events:none}
  .sfx.splat{width:24px;height:24px;opacity:.95;animation:out .38s ease-out forwards}
  .sfx.spark{width:18px;height:18px;animation:out .6s ease-out forwards}
  @keyframes out{to{transform:translate(-50%,-50%) scale(1.8);opacity:0}}

  /* Bath bubble */
  .bubble{position:absolute;width:28px;height:28px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #ffffffaa 0, #ffd6f3 40%, #ffc1ea 70%, #f5a7d5 100%);box-shadow:0 2px 6px #0002}

  /* Ambient stray fly (scene) */
  .stray{position:absolute;top:20%;left:-40px;z-index:3;opacity:.9;filter:drop-shadow(0 3px 4px #0002)}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="brand"><img src="img/header/logo_cacamochi.png" alt="Cacamochi"></div>
    <div class="age" id="age">Jour 1 â€” Bouseau</div>
  </header>

  <main class="stage" id="room">
    <img id="bg" class="bg" alt="PiÃ¨ce" src=""/>

    <div class="hud">
      <div class="bar" id="bHunger"><h3>Faim</h3><div class="meter"><i></i></div></div>
      <div class="bar" id="bFun"><h3>Fun</h3><div class="meter"><i></i></div></div>
      <div class="bar" id="bHyg"><h3>HygiÃ¨ne</h3><div class="meter"><i></i></div></div>
      <div class="bar" id="bEnergy"><h3>Ã‰nergie</h3><div class="meter"><i></i></div></div>
    </div>
    <div class="chips">
      <span class="chip" id="tAff">Affection: 0</span>
      <span class="chip" id="tDis">Discipline: 0</span>
      <span class="chip" id="tOdo">Odeur: 0</span>
    </div>

    <div class="speech" id="speech" style="display:none"><div class="b" id="speechText">Hi!</div><div class="t"></div></div>
    <div id="disco" aria-hidden="true"></div>
    <div id="evolveFX" aria-hidden="true"></div>
    <div class="sunBoost" id="sunBoost" aria-hidden="true"></div>
    <div class="sleepOverlay" id="sleepOverlay"><div class="tint"></div><div class="stars" id="stars"></div><div class="zzz">Z z z ...</div></div>

    <!-- Sprite -->
    <div class="center">
      <svg class="sprite wobble" viewBox="0 0 200 200" id="sprite" aria-label="Cacamochi">
        <ellipse cx="100" cy="170" rx="60" ry="12" fill="#00000022"/>
        <image id="evo-img" href="" x="0" y="0" width="200" height="200" preserveAspectRatio="xMidYMid meet"/>
      </svg>
    </div>

    <!-- Scene buttons -->
    <button type="button" class="gameBtn flies" id="btnFlies"><img class="ico" src="img/icons/mouches.png" alt=""><span class="lbl">Mouches</span></button>
    <button type="button" class="gameBtn bath"  id="btnBath"><img class="ico" src="img/icons/bain.png" alt=""><span class="lbl">Bain</span></button>

    <!-- Plant (SVG, Ã©volutive, + animations) -->
    <div class="plant" id="plant">
      <svg viewBox="0 0 80 90" aria-label="Plante">
        <!-- Pot -->
        <g fill="#c48f6d">
          <rect x="20" y="62" width="40" height="16" rx="4"></rect>
          <rect x="16" y="54" width="48" height="10" rx="5" fill="#b57f5e"></rect>
        </g>
        <!-- STADE 0 : germe -->
        <g id="p0" class="sway" style="display:none">
          <path d="M40 62 C40 55, 40 50, 40 46" stroke="#5a7f4a" stroke-width="3" fill="none" stroke-linecap="round"/>
          <path class="leafW" d="M40 50 C32 46, 30 44, 28 41 C33 41, 35 42, 40 45" fill="#79a45f"/>
          <path class="leafW" d="M40 50 C48 46, 50 44, 52 41 C47 41, 45 42, 40 45" fill="#79a45f"/>
        </g>
        <!-- STADE 1 : jeune plant -->
        <g id="p1" class="sway" style="display:none">
          <path d="M40 62 C40 54, 40 47, 40 42" stroke="#5a7f4a" stroke-width="3" fill="none" stroke-linecap="round"/>
          <ellipse cx="32" cy="46" rx="8" ry="5" fill="#79a45f" class="leafW"/>
          <ellipse cx="48" cy="46" rx="8" ry="5" fill="#79a45f" class="leafW"/>
        </g>
        <!-- STADE 2 : buisson -->
        <g id="p2" class="sway" style="display:none">
          <path d="M40 62 C40 52, 40 40, 40 36" stroke="#5a7f4a" stroke-width="3" fill="none" stroke-linecap="round"/>
          <circle cx="32" cy="44" r="10" fill="#6e9e57" class="leafW"/>
          <circle cx="48" cy="44" r="10" fill="#6e9e57" class="leafW"/>
          <circle cx="40" cy="36" r="9" fill="#79a45f" class="leafW"/>
        </g>
        <!-- STADE 3 : fleur -->
        <g id="p3" class="sway" style="display:none">
          <path d="M40 62 C40 50, 40 34, 40 30" stroke="#5a7f4a" stroke-width="3" fill="none" stroke-linecap="round"/>
          <circle cx="32" cy="44" r="10" fill="#6e9e57" class="leafW"/>
          <circle cx="48" cy="44" r="10" fill="#6e9e57" class="leafW"/>
          <circle cx="40" cy="34" r="12" fill="#79a45f"/>
          <circle cx="40" cy="28" r="6" fill="#ffd7e6" stroke="#eaa0be" stroke-width="2"/>
        </g>
      </svg>
    </div>

    <!-- Dock -->
    <div class="dockWrap">
      <div class="dock" id="dock">
        <button class="btn" id="feed"><img class="ico" src="img/icons/nourrir.png"><span class="lbl">Nourrir</span></button>
        <button class="btn" id="wash"><img class="ico" src="img/icons/laver.png"><span class="lbl">Laver</span></button>
        <button class="btn" id="toilet"><img class="ico" src="img/icons/WC.png"><span class="lbl">WC</span></button>
        <button class="btn" id="sleep"><img class="ico" src="img/icons/dodo.png"><span class="lbl">Dodo</span></button>
        <button class="btn" id="play"><img class="ico" src="img/icons/jouer.png"><span class="lbl">Jouer</span></button>
        <button class="btn" id="heal"><img class="ico" src="img/icons/soigner.png"><span class="lbl">Soigner</span></button>
        <button class="btn" id="snack"><img class="ico" src="img/icons/snack.png"><span class="lbl">Snack</span></button>
        <button class="btn" id="spray"><img class="ico" src="img/icons/desodoriser.png"><span class="lbl">DÃ©so</span></button>
        <button class="btn" id="kiss"><img class="ico" src="img/icons/bisou.png"><span class="lbl">Bisou</span></button>
        <button class="btn" id="nap"><img class="ico" src="img/icons/dodo.png"><span class="lbl">Sieste</span></button>
        <!-- Nouveaux -->
        <button class="btn" id="water">
          <svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2C9 6 6 9 6 13a6 6 0 1 0 12 0c0-4-3-7-6-11z" fill="none" stroke="#7b5644" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span class="lbl">Arroser</span>
        </button>
        <button class="btn" id="sun">
          <svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="4" fill="none" stroke="#7b5644" stroke-width="2"/><g stroke="#7b5644" stroke-width="2"><path d="M12 2v3M12 19v3M2 12h3M19 12h3M4.6 4.6l2.1 2.1M17.3 17.3l2.1 2.1M19.4 4.6l-2.1 2.1M4.6 19.4l2.1-2.1"/></g></svg>
          <span class="lbl">Soleil</span>
        </button>
      </div>
    </div>

    <!-- Modal: Bain -->
    <div class="modal" id="modalBath">
      <div class="panelMG">
        <div class="panelHead">
          <h2>Bain Mousse</h2>
          <div class="info"><span class="timer" id="timeBath">20</span><span class="score" id="scoreBath">0</span></div>
          <button type="button" class="close" id="closeBath">âœ–</button>
        </div>
        <div class="arena bath" id="arenaBath"></div>
      </div>
    </div>

    <!-- Modal: Mouches -->
    <div class="modal" id="modalFlies">
      <div class="panelMG">
        <div class="panelHead">
          <h2>Chasseâ€‘mouches</h2>
          <div class="info"><span class="timer" id="timeFlies">20</span><span class="score" id="scoreFlies">0</span></div>
          <button type="button" class="close" id="closeFlies">âœ–</button>
        </div>
        <div class="arena flygame" id="arenaFlies"></div>
      </div>
    </div>

    <!-- Game Over -->
    <div class="modal" id="gameover">
      <div class="panelMG" style="text-align:center">
        <div class="panelHead"><h2>ðŸ’€ Cacamochi est partiâ€¦</h2></div>
        <div class="arena" style="background:#fff2f0;display:flex;align-items:center;justify-content:center">
          <button type="button" id="restart" style="background:var(--btn);border:none;border-radius:12px;padding:.7rem 1rem;font-weight:800;color:var(--marron-2);box-shadow:0 6px 14px var(--shadow)">Recommencer</button>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
(()=> {
  /* ---------- Base & Ã©tat ---------- */
  const CONFIG = {
    background: "img_background.jpg",
    sprites: {
      bouseau:   { src: "img_bouseau.png",   x:0,y:0,w:200,h:200 },
      cacabra:   { src: "img_cacabra.png",   x:0,y:0,w:200,h:200 },
      seigneur:  { src: "img_seigneur.png",  x:0,y:0,w:200,h:200 },
      skatour:   { src: "img_skatour.png",   x:0,y:0,w:200,h:200 },
      skalibur:  { src: "img_skalibur.png",  x:0,y:0,w:200,h:200 },
      crottombe: { src: "img_crottombe.png", x:0,y:0,w:200,h:200 },
      thanabouse:{ src: "img_thanabouse.png",x:0,y:0,w:200,h:200 }
    }
  };

  function $(s,r){ return (r||document).querySelector(s); }
  const app={hunger:70,fun:70,hyg:70,energy:70,day:1,alive:true,asleep:false,
             evo:"bouseau",affection:0,discipline:0,odor:0};

  const bar={ hunger:$("#bHunger .meter i"), fun:$("#bFun .meter i"), hyg:$("#bHyg .meter i"), energy:$("#bEnergy .meter i") };
  const bars={ hunger:$("#bHunger"), fun:$("#bFun"), hyg:$("#bHyg"), energy:$("#bEnergy") };
  const age=$("#age"), speech=$("#speech"), speechText=$("#speechText");
  const bg=$("#bg"), evoImg=$("#evo-img"), sprite=$("#sprite");
  const traitsEls={aff:$("#tAff"), dis:$("#tDis"), odo:$("#tOdo")};
  const stars=$("#stars"), gameover=$("#gameover"), sunOverlay=$("#sunBoost");

  const evoName=function(id){ var m={bouseau:"Bouseau",cacabra:"Cacabra",seigneur:"SeignÅ“ur",skatour:"Skatour",skalibur:"Skalibur",crottombe:"Crottombe",thanabouse:"Thanabouse"}; return m[id]||"???"; };
  const say=function(txt){ speechText.textContent=txt; speech.style.display='block'; clearTimeout(say.t); say.t=setTimeout(function(){speech.style.display='none';},1400); };
  const applyBackground=function(){ bg.src=CONFIG.background; };
  function applySprite(){ var s=CONFIG.sprites[app.evo]; if(!s) return;
    evoImg.setAttribute('href',s.src); evoImg.setAttribute('x',s.x||0); evoImg.setAttribute('y',s.y||0);
    evoImg.setAttribute('width',s.w||200); evoImg.setAttribute('height',s.h||200);
  }
  function setMeter(name,val){ val=Math.max(0,Math.min(100,val)); bar[name].style.width=val+"%";
    bars[name].classList.toggle('bad',val<35); bars[name].classList.toggle('mid',val>=35&&val<65); bars[name].classList.toggle('good',val>=65); app[name]=val; }
  const TRAIT_LIMITS={ affection:{min:0,max:30}, discipline:{min:0,max:30}, odor:{min:0,max:20} };
  function setTrait(name,delta,min,max){
    var limits=TRAIT_LIMITS[name]||{};
    var minVal=(typeof min==='number')?min:(typeof limits.min==='number'?limits.min:-999);
    var maxVal=(typeof max==='number')?max:(typeof limits.max==='number'?limits.max:999);
    app[name]=Math.max(minVal,Math.min(maxVal,app[name]+delta));
  }
  function avg(){ var s=0; for(var i=0;i<arguments.length;i++) s+=arguments[i]; return s/arguments.length; }
  function updateAll(){
    setMeter('hunger',app.hunger); setMeter('fun',app.fun); setMeter('hyg',app.hyg); setMeter('energy',app.energy);
    traitsEls.aff.textContent="Affection: "+app.affection; traitsEls.dis.textContent="Discipline: "+app.discipline; traitsEls.odo.textContent="Odeur: "+app.odor;
    age.textContent="Jour "+app.day+" â€” "+evoName(app.evo); applySprite();
    document.body.classList.toggle('sleeping', app.asleep);
  }
  const load=function(){ try{var s=JSON.parse(localStorage.getItem("cacamochi-deluxe+")); if(s) for(var k in s) app[k]=s[k];}catch(e){} };
  const save=function(){ localStorage.setItem("cacamochi-deluxe+", JSON.stringify(app)); };

  /* Night stars */
  for(var i=0;i<36;i++){ var st=document.createElement('div'); st.className='star';
    st.style.left=(Math.random()*100)+'%'; st.style.top=(Math.random()*100)+'%'; st.style.animationDelay=(Math.random()*2)+'s'; stars.appendChild(st); }

  /* ---------- Plante Ã©volutive + anim ---------- */
  var plantState = { xp:0, stage:0, boost:false, boostEnd:0, waterCd:0 };
  var PLANT_KEY="cacamochi-plant";
  function plantLoad(){ try{var s=JSON.parse(localStorage.getItem(PLANT_KEY)); if(s){ plantState.xp=s.xp||0; }}catch(e){} }
  function plantSave(){ localStorage.setItem(PLANT_KEY, JSON.stringify({xp:plantState.xp})); }
  function plantStageFromXp(xp){ if(xp>=24) return 3; if(xp>=14) return 2; if(xp>=6) return 1; return 0; }
  function plantRender(){
    var st=plantStageFromXp(plantState.xp); plantState.stage=st;
    for(var j=0;j<=3;j++){ var g=document.getElementById("p"+j); if(g) g.style.display=(j===st)?"block":"none"; }
    // wiggle des feuilles (lÃ©gÃ¨re secousse pÃ©riodique)
    var leaves=document.querySelectorAll('#p'+st+' .leafW, #p'+st+' .leafWiggle');
    for(var k=0;k<leaves.length;k++){ leaves[k].classList.add('leafWiggle'); (function(el){ setTimeout(function(){ el.classList.remove('leafWiggle'); }, 1200); })(leaves[k]); }
  }
  function addBurstAround(el, color){
    var rect=el.getBoundingClientRect(), cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
    for(var i=0;i<6;i++){ var a=Math.random()*Math.PI*2, d=20+Math.random()*26; var dx=Math.cos(a)*d, dy=Math.sin(a)*d;
      var p=document.createElement('div'); p.className='p'; p.style.background=color||'#ffd6a3';
      p.style.left=(cx-5)+'px'; p.style.top=(cy-5)+'px'; p.style.setProperty('--tr',"translate("+dx+"px,"+dy+"px)");
      document.body.appendChild(p); setTimeout((function(el){return function(){el.remove();};})(p),800);
    }
  }
  function plantGain(n){
    if(plantState.boost) n = Math.ceil(n*1.8);
    plantState.xp=Math.max(0, Math.min(999, plantState.xp + n));
    plantRender(); plantSave();
    var p=document.getElementById('plant'); p.classList.add('grow'); setTimeout(function(){p.classList.remove('grow');},600);
    addBurstAround(p, plantState.boost ? '#ffe37c' : '#c5f2a4');
  }
  function plantInit(){ plantLoad(); plantRender(); }

  /* Boost soleil â€” TOGGLE + durÃ©e courte (8s) */
  function sunOn(){
    if(plantState.boost){ sunOff(); return; } // toggle off si dÃ©jÃ  actif
    if(app.energy<40 || app.hyg<40){ say("Pas assez en forme pour bronzer !"); return; }
    plantState.boost=true; plantState.boostEnd=Date.now()+8000; // 8s
    sunOverlay.classList.add('on'); document.getElementById('plant').classList.add('boost');
    say("â˜€ï¸ Soleil : boost 8s !");
    setTimeout(function(){ if(plantState.boost) sunOff(); }, 8200);
  }
  function sunOff(){
    plantState.boost=false; sunOverlay.classList.remove('on'); document.getElementById('plant').classList.remove('boost'); say("ðŸŒ¤ Fin du boost");
  }

  /* Arroser : +XP, coÃ»t Ã©nergie, cooldown 10s */
  function canWater(){ return Date.now() > plantState.waterCd; }
  function waterOnce(){
    if(!canWater()){ say("Patiente un peuâ€¦ ðŸ’§"); return; }
    if(app.energy<8){ say("Trop fatiguÃ© pour arroser."); return; }
    setMeter('energy', app.energy-8);
    plantGain(2);
    plantState.waterCd = Date.now()+10000;
    say("ðŸ’§ Glou glou !");
    updateAll(); save();
  }

  /* ---------- Actions dock ---------- */
  $("#feed").onclick = function(){ if(!app.alive) return; setMeter('hunger',app.hunger+22); setMeter('hyg',app.hyg-6); setMeter('energy',app.energy+6); setTrait('affection',+1); setTrait('odor',+1); plantGain(1); say("Miam !"); updateAll(); save(); };
  $("#wash").onclick = function(){ if(!app.alive) return; setMeter('hyg',app.hyg+30); setTrait('odor',-3); sprite.classList.add('wash'); setTimeout(function(){sprite.classList.remove('wash');},2100); plantGain(1); say("Tout propre !"); updateAll(); save(); };
  $("#toilet").onclick= function(){ if(!app.alive) return; setMeter('hyg',app.hyg+40); setTrait('odor',-6); plantGain(1); say("ðŸ§» Fiuuut !"); updateAll(); save(); };
  $("#sleep").onclick = function(){ if(!app.alive) return; app.asleep=!app.asleep; say(app.asleep?"Bonne nuit...":"RÃ©veil !"); updateAll(); save(); };
  $("#play").onclick  = function(){ if(!app.alive) return;
    // Animation de jeu + confettis
    sprite.classList.add('playshake'); setTimeout(function(){ sprite.classList.remove('playshake'); }, 820);
    addBurstAround(sprite, '#ffb5cf'); addBurstAround(sprite, '#ffd285');
    setMeter('fun',app.fun+18); setMeter('energy',app.energy-9); setTrait('discipline',+1); setTrait('odor',+1);
    say("On joue !"); updateAll(); save();
  };
  $("#heal").onclick  = function(){ if(!app.alive) return; var low=['hunger','fun','hyg','energy'].some(function(k){ return app[k]<35; }); if(low){['hunger','fun','hyg','energy'].forEach(function(k){ setMeter(k,app[k]+8); }); say("ðŸ’Š Ã‡a va mieux.");} else say("Pas besoin."); updateAll(); save(); };
  $("#snack").onclick = function(){ if(!app.alive) return; var r=Math.random(); if(r<.33){ setMeter('hunger',app.hunger+16); plantGain(1); say("Snack salÃ© ðŸ˜‹"); } else if(r<.66){ setMeter('fun',app.fun+14); say("Snack sucrÃ© ðŸ¤¤"); } else { setMeter('hunger',app.hunger+8); setTrait('odor',+2); say("Snack douteux ðŸ˜¬"); } updateAll(); save(); };
  $("#spray").onclick = function(){ if(!app.alive) return; setTrait('odor',-6); setMeter('hyg',app.hyg+6); setMeter('energy',app.energy-4); plantGain(1); say("Pschiiit ! Ã‡a sent bon âœ¨"); updateAll(); save(); };
  $("#kiss").onclick  = function(){ if(!app.alive) return; setTrait('affection',+3); setMeter('fun',app.fun+6); say("Bisou ðŸ’•"); updateAll(); save(); };
  $("#nap").onclick   = function(){ if(!app.alive) return; setMeter('energy',app.energy+14); setMeter('fun',app.fun-4); app.asleep=false; say("Petite sieste ðŸ˜´"); updateAll(); save(); };
  $("#water").onclick = function(){ if(!app.alive) return; waterOnce(); };
  $("#sun").onclick   = function(){ if(!app.alive) return; sunOn(); };

  /* Dock centering UX */
  var wrap = document.querySelector('.dockWrap');
  document.getElementById('dock').addEventListener('click', function(e){
    var b = e.target.closest('button'); if(!b) return;
    var target = b.offsetLeft - (wrap.clientWidth - b.clientWidth)/2;
    wrap.scrollTo({ left: Math.max(0, target), behavior: 'smooth' });
    setTimeout(function(){ b.blur(); }, 120);
  });

  /* Doubleâ€‘tap dance */
  (function(){ var last=0;
    sprite.addEventListener('touchend',function(){var now=Date.now(); if(now-last<300){dance();} last=now;},{passive:true});
    sprite.addEventListener('click',function(){var now=Date.now(); if(now-last<300){dance();} last=now;});
    function dance(){ if(!app.alive) return; document.body.classList.add('disco-on'); sprite.classList.add('dance'); setTimeout(function(){ sprite.classList.remove('dance'); document.body.classList.remove('disco-on'); }, 2800); setMeter('fun',app.fun+10); setMeter('energy',app.energy-6); say("Disco !"); updateAll(); save(); }
  })();

  /* Plant nod on good actions */
  var plantEl = $("#plant"); var plantTimer=0;
  function plantNod(){ plantEl.classList.add('grow'); clearTimeout(plantTimer); plantTimer=setTimeout(function(){plantEl.classList.remove('grow');}, 600); }
  ["feed","wash","toilet","snack","spray","water"].forEach(function(id){ $("#"+id).addEventListener('click',plantNod); });

  /* ---------- Ambient: mouche qui traverse ---------- */
  (function(){
    var room = $("#room");
    function spawnStray(){
      if(Math.random()<0.5) return; // pas Ã  chaque tick
      var img=document.createElement('img');
      img.src="img/flies/fly_small.png"; img.className="stray"; room.appendChild(img);
      // point de dÃ©part alÃ©atoire (gauche->droite ou lâ€™inverse)
      var h=room.clientHeight||window.innerHeight;
      var y = (h*0.25) + Math.random()*(h*0.4);
      var leftToRight = Math.random()>0.5;
      var startX = leftToRight ? -40 : (room.clientWidth+40);
      var endX   = leftToRight ? (room.clientWidth+60) : -60;
      var start = performance.now(); var dur = 4500 + Math.random()*2500;
      function step(t){
        var p=(t-start)/dur; if(p>=1){ img.remove(); return; }
        var x = startX + (endX-startX)*p;
        // petite sinusoÃ¯de pour le vol
        var yy = y + Math.sin(p*Math.PI*4)*12;
        img.style.transform="translate("+x+"px,"+yy+"px) scale(0.9)";
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
      // retire au cas oÃ¹
      setTimeout(function(){ img.remove(); }, dur+200);
    }
    // cadence alÃ©atoire : toutes 10â€“20 s
    setInterval(function(){ spawnStray(); }, 10000);
  })();

  /* ---------- Jeu MOUCHES v3.2 ---------- */
  (function(){
    var modal   = $("#modalFlies");
    var arena   = $("#arenaFlies");
    var scoreEl = $("#scoreFlies");
    var timeEl  = $("#timeFlies");
    var btnOpen = $("#btnFlies");
    var btnClose= $("#closeFlies");

    var A = {
      small:"img/flies/fly_small.png",
      big  :"img/flies/fly_big.png",
      gold :"img/flies/fly_gold.png",
      splat:"img/flies/splat.png",
      spark:"img/flies/spark.png"
    };

    var difficulty = [
      { time:0,  speed:1,    cap:10, cadence:[600,800], weights:{ small:0.88, big:0.10, gold:0.02 } },
      { time:5,  speed:1.2,  cap:12, cadence:[520,720], weights:{ small:0.82, big:0.14, gold:0.04 } },
      { time:10, speed:1.35, cap:14, cadence:[440,640], weights:{ small:0.76, big:0.17, gold:0.07 } },
      { time:15, speed:1.55, cap:16, cadence:[360,520], weights:{ small:0.70, big:0.20, gold:0.10 } }
    ];
    var defaultWeights = { small:0.7, big:0.2, gold:0.1 };
    var flyStats = {
      small:{ speed:55, hp:1, pts:1, src:A.small },
      big  :{ speed:42, hp:2, pts:2, src:A.big },
      gold :{ speed:75, hp:1, pts:5, src:A.gold }
    };
    var currentDifficulty = difficulty[0];

    var medalKey = "cacamochi:fliesMedal";
    var medalOrder = { none:0, bronze:1, argent:2, or:3, platine:4 };
    var bestMedalStored = "none";
    try { bestMedalStored = localStorage.getItem(medalKey) || "none"; }
    catch(_){ bestMedalStored = "none"; }

    var RAF=0, running=false, startTs=0, score=0, spawnTimer=0, timeLeft=20;
    var flies=[];
    var streak=0, bestMultiplier=1, lastKillTs=0;

    function updateScoreDisplay(){
      var mult=Math.max(1,streak);
      scoreEl.textContent = score + " Ã—" + mult;
    }

    function resetStreak(){
      if(streak>0){
        streak=0;
        updateScoreDisplay();
      }
      lastKillTs=0;
    }

    function registerKill(){
      var now = performance.now();
      if(!lastKillTs || (now-lastKillTs)>800){ streak=1; }
      else { streak++; }
      lastKillTs=now;
      if(streak>bestMultiplier) bestMultiplier=streak;
      updateScoreDisplay();
    }

    function registerMiss(){
      if(!running) return;
      resetStreak();
    }

    function handleMiss(ev){
      if(ev.target && ev.target.classList && ev.target.classList.contains('fly')) return;
      registerMiss();
    }

    function spawnOne(){
      var arenaW=arena.clientWidth, arenaH=arena.clientHeight;
      var img=document.createElement('img');
      var types=['small','big','gold'];
      var weights=currentDifficulty.weights||defaultWeights;
      var total=0;
      var dist=[];
      for(var i=0;i<types.length;i++){
        var t=types[i];
        var weight=Number(weights[t]);
        if(!weight||weight<=0) continue;
        total+=weight;
        dist.push({ type:t, cumulative:total });
      }
      if(total<=0){
        weights=defaultWeights;
        total=0; dist=[];
        for(var j=0;j<types.length;j++){
          var tt=types[j];
          var ww=Number(weights[tt]);
          if(!ww||ww<=0) continue;
          total+=ww;
          dist.push({ type:tt, cumulative:total });
        }
      }
      var draw=Math.random()*total;
      var type=(dist.length?dist[dist.length-1].type:'small');
      for(var k=0;k<dist.length;k++){
        if(draw<dist[k].cumulative){ type=dist[k].type; break; }
      }
      var stats=flyStats[type]||flyStats.small;
      var speed=stats.speed, hp=stats.hp, pts=stats.pts, src=stats.src;
      img.src=src; img.className='fly '+type; img.draggable=false; arena.appendChild(img);
      var mult=currentDifficulty.speed;
      speed*=mult;
      var f={ el:img, x:Math.random()*arenaW, y:Math.random()*arenaH, vx:(Math.random()*2-1)*speed, vy:(Math.random()*2-1)*speed, t:0, hp:hp, pts:pts, dead:false, type:type };
      var hit=function(ev){
        ev.stopPropagation();
        f.hp--;
        var dead=f.hp<=0;
        pop(f.x,f.y,dead,type==='gold');
        if(dead){
          f.dead=true;
          score+=f.pts;
          registerKill();
          img.remove();
        }
      };
      img.addEventListener('mousedown',hit); img.addEventListener('touchstart',hit,{passive:true});
      flies.push(f);
    }
    function pop(x,y,dead,gold){
      var fx=document.createElement('img'); fx.src=dead?A.splat:(A.spark||A.splat); fx.className=dead?'sfx splat':'sfx spark';
      fx.style.left=x+'px'; fx.style.top=y+'px'; arena.appendChild(fx); setTimeout(function(){fx.remove();}, dead?380:600);
      if(gold && A.spark){ var fx2=document.createElement('img'); fx2.src=A.spark; fx2.className='sfx spark'; fx2.style.left=(x+10)+'px'; fx2.style.top=(y-10)+'px'; arena.appendChild(fx2); setTimeout(function(){fx2.remove();},600); }
    }
    function updateDifficulty(elapsed){
      var next=currentDifficulty;
      for(var i=0;i<difficulty.length;i++){
        if(elapsed>=difficulty[i].time) next=difficulty[i];
      }
      if(next!==currentDifficulty){
        currentDifficulty=next;
        scheduleNextSpawn(true);
      }
    }
    function scheduleNextSpawn(force){
      clearTimeout(spawnTimer);
      if(!running) return;
      if(force){ cadence(); return; }
      var range=currentDifficulty.cadence;
      var delay=range[0]+Math.random()*(range[1]-range[0]);
      spawnTimer=setTimeout(cadence, delay);
    }
    function loop(t){
      if(!running) return;
      if(!startTs) startTs=t;
      var dt=Math.min(32, t-(loop.prev||t)); loop.prev=t;
      var w=arena.clientWidth, h=arena.clientHeight;
      for(var i=0;i<flies.length;i++){
        var f=flies[i]; if(f.dead) continue; f.t+=dt;
        if(f.t>400){ f.vx += (Math.random()*2-1)*22; f.vy += (Math.random()*2-1)*22; f.t=0; }
        f.x += f.vx*dt/1000; f.y += f.vy*dt/1000;
        if(f.x<12||f.x>w-12) f.vx*=-1; if(f.y<12||f.y>h-12) f.vy*=-1;
        f.el.style.transform="translate("+f.x+"px,"+f.y+"px)";
      }
      var elapsed=(t-startTs)/1000;
      updateDifficulty(elapsed);
      if(streak>0 && lastKillTs && (t-lastKillTs)>800){ resetStreak(); }
      var remain=Math.max(0, 20 - Math.floor(elapsed));
      if(remain!==timeLeft){ timeLeft=remain; timeEl.textContent=timeLeft; }
      if(elapsed>=20){ stop(true); return; }
      RAF=requestAnimationFrame(loop);
    }
    function cadence(){
      if(!running) return;
      var alive=0; for(var i=0;i<flies.length;i++) if(!flies[i].dead) alive++;
      if(alive<currentDifficulty.cap) spawnOne();
      scheduleNextSpawn(false);
    }
    arena.addEventListener('mousedown',handleMiss);
    arena.addEventListener('touchstart',handleMiss,{passive:true});
    function start(){
      score=0; streak=0; bestMultiplier=1; lastKillTs=0; updateScoreDisplay();
      timeLeft=20; timeEl.textContent='20';
      flies.length=0; loop.prev=0; startTs=0; currentDifficulty=difficulty[0];
      modal.classList.add('on'); running=true;
      requestAnimationFrame(function(){ for(var i=0;i<6;i++) spawnOne(); cadence(); RAF=requestAnimationFrame(loop); });
    }
    function stop(reward){
      running=false; cancelAnimationFrame(RAF); clearTimeout(spawnTimer);
      for(var i=0;i<flies.length;i++){ if(flies[i].el) flies[i].el.remove(); }
      flies.length=0;
      setTimeout(function(){ modal.classList.remove('on'); },150);
      if(reward){
        var combo=Math.max(1,bestMultiplier);
        var effectiveScore=Math.round(score*(1+Math.max(0,combo-1)*0.25));
        var funGain=8, disGain=1, odorGain=-1, plant=1, message="Pas mal.";
        if(effectiveScore>=24){ funGain=24; disGain=4; odorGain=-3; plant=3; message="MaÃ®tre moucheur !"; }
        else if(effectiveScore>=16){ funGain=18; disGain=3; odorGain=-2; plant=2; message="Chasseur agile !"; }
        else if(effectiveScore>=12){ funGain=16; disGain=2; odorGain=-2; plant=2; message="Bonne chasse !"; }
        var medal='none';
        if(combo>=9) medal='platine';
        else if(combo>=7) medal='or';
        else if(combo>=5) medal='argent';
        else if(combo>=3) medal='bronze';
        var medalBonus={
          bronze:{fun:4, dis:1, odor:0, title:"ðŸ¥‰ MÃ©daille de bronze", label:"ðŸ¥‰ Bronze"},
          argent:{fun:7, dis:2, odor:-1, title:"ðŸ¥ˆ MÃ©daille d'argent", label:"ðŸ¥ˆ Argent"},
          or:{fun:10, dis:3, odor:-1, title:"ðŸ… MÃ©daille d'or", label:"ðŸ… Or"},
          platine:{fun:14, dis:4, odor:-2, title:"ðŸ† MÃ©daille de platine", label:"ðŸ† Platine"}
        };
        var prevBest=bestMedalStored;
        if(medal!=='none'){
          var bonus=medalBonus[medal];
          funGain+=bonus.fun; disGain+=bonus.dis; odorGain+=bonus.odor;
          message=bonus.title+" !";
        }
        var recordBeat=false;
        if(medal!=='none' && medalOrder[medal]>medalOrder[prevBest]){
          try{ localStorage.setItem(medalKey, medal); }catch(_){ }
          bestMedalStored=medal; recordBeat=true;
        }
        var comboText="Combo Ã—"+combo;
        if(!recordBeat && prevBest!=='none'){
          var recordLabel=medalBonus[prevBest]?medalBonus[prevBest].label:prevBest;
          if(medal==='none' || medalOrder[prevBest]>medalOrder[medal]){
            message+=" (Record: "+recordLabel+")";
          } else if(medal===prevBest){
            message+=" (Record Ã©galÃ©)";
          }
        }
        if(recordBeat){ message+=" â€” Nouveau record !"; }
        message+=" Â· "+comboText;
        setMeter('fun', app.fun+funGain);
        setTrait('discipline', +disGain);
        setTrait('odor', odorGain);
        plantGain(plant);
        say(message);
        updateAll(); save();
      }
    }
    $("#btnFlies").addEventListener('click', function(){ if(app.alive) start(); });
    $("#closeFlies").addEventListener('click', function(){ stop(false); });
    modal.addEventListener('click', function(e){ if(e.target===modal) stop(false); });
  })();

  /* ---------- Jeu BAIN (robuste) ---------- */
  (function(){
    var modal=$("#modalBath"), arena=$("#arenaBath"), scoreEl=$("#scoreBath"), timeEl=$("#timeBath");
    var timer=null, left=20, score=0, alive=false;

    function spawn(){
      var b=document.createElement('div'); b.className='bubble';
      var x=Math.random()*(arena.clientWidth-30)+15, y=arena.clientHeight+20;
      b.style.left=(x-14)+'px'; b.style.top=(y-14)+'px';
      var dur=1000+Math.random()*1400; var start=performance.now();
      var step=function(t){ if(!alive){ b.remove(); return; } var p=(t-start)/dur; if(p>=1){ b.remove(); return; } b.style.top=(y - p*(arena.clientHeight+80) - 14)+'px'; requestAnimationFrame(step); };
      var hit=function(){ score++; scoreEl.textContent=score; b.remove(); };
      b.addEventListener('click',hit); b.addEventListener('touchstart',hit,{passive:true});
      arena.appendChild(b); requestAnimationFrame(step);
    }
    function tick(){
      if(!alive) return;
      left--; timeEl.textContent=left;
      if(left<=0){ end(true); return; }
      for(var i=0;i<2+Math.floor(Math.random()*3);i++) spawn();
      timer=setTimeout(tick,1000);
    }
    function start(){ modal.classList.add('on'); arena.innerHTML=''; score=0; scoreEl.textContent='0'; left=20; timeEl.textContent='20'; alive=true; tick(); }
    function end(reward){ alive=false; clearTimeout(timer);
      setTimeout(function(){
        modal.classList.remove('on'); arena.innerHTML='';
        if(reward){
          var s=score;
          if(s>=25){ setMeter('hyg',app.hyg+30); setMeter('fun',app.fun+18); setTrait('odor',-4); plantGain(2); say("ðŸ«§ Roi de la mousse !"); }
          else if(s>=12){ setMeter('hyg',app.hyg+20); setMeter('fun',app.fun+12); setTrait('odor',-3); plantGain(2); say("ðŸ«§ Bien jouÃ© !"); }
          else { setMeter('hyg',app.hyg+12); setMeter('fun',app.fun+6); setTrait('odor',-2); plantGain(1); say("ðŸ«§ Pas mal."); }
          updateAll(); save();
        }
      },200);
    }
    $("#btnBath").addEventListener('click', function(){ if(app.alive) start(); });
    $("#closeBath").addEventListener('click', function(){ end(false); });
    $("#modalBath").addEventListener('click', function(e){ if(e.target===modal) end(false); });
  })();

  /* ---------- Ã‰vÃ©nements alÃ©atoires + temps ---------- */
  setInterval(function(){ if(!app.alive) return; var r=Math.random();
    if(r<.18){ say("Une mouche sâ€™est posÃ©e..."); setMeter('hyg',app.hyg-4); setTrait('odor',+1); updateAll(); }
    else if(r<.28){ say("Petit rot discret."); setMeter('hunger',app.hunger+3); setTrait('odor',+1); updateAll(); }
  }, 30000);

  function tick(){ if(!app.alive) return;
    var k=app.asleep?0.45:1;
    setMeter('hunger',app.hunger-0.6*k); setMeter('fun',app.fun-0.45*k); setMeter('hyg',app.hyg-0.35*k);
    setMeter('energy', app.energy-(app.asleep?-0.9:0.7));
    if(['hunger','fun','hyg','energy'].filter(function(x){return app[x]<=0;}).length>=2){ app.alive=false; gameover.classList.add('on'); say("ðŸ’€ RIP Cacamochi..."); }
    // Fin de boost soleil si temps Ã©coulÃ©
    if(plantState.boost && Date.now()>plantState.boostEnd){ sunOff(); }
    updateAll();
  }
  function newDay(){ if(!app.alive) return; app.day++; say("â˜€ï¸ Jour "+app.day); setMeter('hyg',app.hyg-5); setMeter('hunger',app.hunger-6); evolveCheck(); save(); updateAll(); }
  setInterval(tick,1200); setInterval(newDay, 1.2*60*1000);

  /* ---------- Ã‰volutions ---------- */
  function evolveCheck(){
    var mood=avg(app.hunger,app.fun,app.hyg,app.energy);
    var clean=app.hyg - app.odor*1.5, playful=app.fun + app.affection, stoic=app.energy - app.discipline*0.5;
    if(app.day>=2 && app.evo==="bouseau"){
      if(clean>=60 && playful>=60) evolveTo("cacabra");
      else if(playful>=65 && clean<60) evolveTo("skatour");
      else if(stoic<45) evolveTo("crottombe");
    }
    if(app.day>=4){
      if(app.evo==="cacabra"   && mood>78 && app.discipline>=4) evolveTo("seigneur");
      if(app.evo==="skatour"   && playful>80)                  evolveTo("skalibur");
      if(app.evo==="crottombe" && (clean<45 || app.energy<40)) evolveTo("thanabouse");
    }
  }
  function evolveTo(next){
    if(app.evo===next) return; app.evo=next;
    var sEl=$("#sprite"); sEl.style.transition="transform .35s ease, filter .35s ease";
    sEl.style.transform="scale(1.1)"; sEl.style.filter="drop-shadow(0 28px 24px var(--shadow)) saturate(1.2)";
    setTimeout(function(){ applySprite(); },120);
    var fx=$("#evolveFX"), rect=sEl.getBoundingClientRect();
    var cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
    for(var i=0;i<32;i++){ var a=Math.random()*Math.PI*2, d=60+Math.random()*120; var dx=Math.cos(a)*d, dy=Math.sin(a)*d; var p=document.createElement('div'); p.className='p'; p.style.background='#ffd7e6'; p.style.left=(cx-5)+"px"; p.style.top=(cy-5)+"px"; p.style.setProperty('--tr',"translate("+dx+"px,"+dy+"px)"); document.body.appendChild(p); setTimeout((function(el){return function(){el.remove();};})(p),800); }
    setTimeout(function(){ sEl.style.transform=""; sEl.style.filter=""; },400);
    say("âœ¨ Ã‰volution : "+evoName(next)+" !");
  }

  /* ---------- Restart ---------- */
  $("#restart").onclick = function(){
    var fresh={hunger:70,fun:70,hyg:70,energy:70,day:1,alive:true,asleep:false,evo:"bouseau",affection:0,discipline:0,odor:0};
    for(var k in fresh) app[k]=fresh[k];
    gameover.classList.remove('on'); applySprite(); updateAll(); save();
  };

  /* ---------- Init ---------- */
  applyBackground(); load(); updateAll(); plantInit();
})();
</script>
</body>
</html>
