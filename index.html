<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cacamochi â€” v3</title>
<style>
  :root{
    --bg:#ece8df;
    --glass: #ffffffc7;
    --shadow: #00000025;
    --good:#58c66a; --mid:#ffb84d; --bad:#ff6565;
    --pill:#fff; --pillText:#222;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .app{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}

  /* header */
  header{display:flex;align-items:center;gap:.8rem;padding:.6rem .9rem}
  header h1{margin:0;font-size:1.05rem}
  .age{margin-left:auto;background:var(--glass);backdrop-filter:blur(6px);
    padding:.25rem .6rem;border-radius:999px;box-shadow:0 2px 6px var(--shadow);font-weight:700;font-size:.85rem}

  /* main stage */
  .stage-wrap{position:relative;overflow:hidden}
  .room-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .center{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
  .sprite{width:clamp(160px,28vmin,360px);pointer-events:auto;filter:drop-shadow(0 18px 12px var(--shadow))}
  .wobble{animation:wobble 2.4s ease-in-out infinite}
  @keyframes wobble{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-3%) scale(1.02)}}
  .wash{animation:wash .7s ease-in-out 3}@keyframes wash{0%{filter:hue-rotate(0)}50%{filter:hue-rotate(90deg) saturate(1.2)}100%{filter:hue-rotate(0)}}
  .dance{animation:dance .7s ease-in-out 4}@keyframes dance{0%{transform:translateX(0) rotate(0)}25%{transform:translateX(-8%) rotate(-6deg)}50%{transform:translateX(0) rotate(0)}75%{transform:translateX(8%) rotate(6deg)}100%{transform:translateX(0) rotate(0)}}
  .shake{animation:shake .6s cubic-bezier(.36,.07,.19,.97)}@keyframes shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}
  .flash{position:absolute;inset:0;background:#fff;opacity:0;pointer-events:none}
  .flash.on{animation:flash .55s ease}@keyframes flash{0%{opacity:0}10%{opacity:.9}100%{opacity:0}}

  /* stink + flies */
  .steam line{animation:steam 3.6s ease-in-out infinite}
  @keyframes steam{0%{opacity:0;transform:translateY(8px)}20%{opacity:.9}100%{opacity:0;transform:translateY(-26px)}}
  .flies{animation:orbit 6s linear infinite;transform-origin:center}
  @keyframes orbit{from{transform:rotate(0)}to{transform:rotate(360deg)}}

  /* HUD (glass) */
  .hud{position:absolute;top:.6rem;left:50%;transform:translateX(-50%);
    display:grid;grid-template-columns:repeat(4,minmax(160px,220px));gap:.6rem;align-items:start;
    background:var(--glass);backdrop-filter:blur(6px);padding:.6rem;border-radius:16px;box-shadow:0 6px 20px var(--shadow)}
  .bar h3{margin:0 0 .25rem 0;font-size:.78rem}
  .meter{height:8px;background:#00000012;border-radius:99px;overflow:hidden}
  .meter>i{display:block;height:100%;width:50%;background:linear-gradient(90deg,var(--good),#9ee68b);transition:width .3s}
  .bad>i{background:linear-gradient(90deg,var(--bad),#ff8484)}
  .mid>i{background:linear-gradient(90deg,var(--mid),#ffd399)}
  .traits{position:absolute;top:calc(.6rem + 74px);left:50%;transform:translateX(-50%);display:flex;gap:.4rem;flex-wrap:wrap}
  .chip{background:var(--glass);backdrop-filter:blur(6px);padding:.25rem .55rem;border-radius:999px;font-size:.78rem;box-shadow:0 2px 6px var(--shadow)}

  /* states */
  .state{position:absolute;left:.6rem;bottom:.6rem;display:flex;gap:.4rem;flex-wrap:wrap}
  .label{background:var(--glass);backdrop-filter:blur(4px);padding:.35rem .7rem;border-radius:999px;box-shadow:0 2px 6px var(--shadow);font-weight:700}

  /* actions â€” cute pills */
  .actions{position:absolute;right:.6rem;bottom:.6rem;display:grid;grid-template-columns:repeat(5,minmax(120px,1fr));gap:.5rem}
  @media (max-width:1100px){ .actions{grid-template-columns:repeat(4,1fr)} .hud{grid-template-columns:repeat(2,minmax(150px,220px))} }
  @media (max-width:700px){ .actions{grid-template-columns:repeat(2,1fr)} .traits{display:none} .hud{grid-template-columns:repeat(2,minmax(130px,1fr))} }
  button{
    -webkit-tap-highlight-color: transparent;
    cursor:pointer;border:none;border-radius:14px;padding:.65rem .75rem;
    background:var(--pill);color:var(--pillText);font-weight:800;font-size:.92rem;
    box-shadow:0 6px 16px var(--shadow);display:flex;gap:.5rem;align-items:center;justify-content:center;
    transition:transform .08s ease, box-shadow .08s ease, filter .08s ease;
  }
  button:active{ transform:translateY(2px); box-shadow:0 3px 8px var(--shadow) }
  button:hover{ filter:brightness(1.03) }
  button[disabled]{opacity:.45;pointer-events:none}

  /* modal miniâ€‘jeu */
  .modal{position:absolute;inset:0;background:#00000060;display:none;align-items:center;justify-content:center}
  .modal.on{display:flex}
  .panel{width:min(560px,92vw);height:min(360px,70vh);background:#f6f3ee;border-radius:16px;box-shadow:0 10px 30px #00000040;position:relative;overflow:hidden}
  .panel h2{margin:10px 12px;font-size:16px}
  .arena{position:absolute;inset:50px 12px 12px 12px;background:#dfe8c8;border-radius:12px;overflow:hidden;cursor:crosshair}
  .fly{position:absolute;width:26px;height:20px}
  .arena .fly:after{content:"ğŸª°";font-size:20px;line-height:20px}
  .score{position:absolute;right:12px;top:12px;font-weight:800}
  .close{position:absolute;right:10px;top:8px}
  .hidden{display:none}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <h1>ğŸ’© Cacamochi</h1>
    <div class="age" id="age">Jour 1 â€” Bouseau</div>
  </header>

  <main class="stage-wrap" id="room">
    <img id="bg" class="room-img" alt="PiÃ¨ce" src=""/>

    <div class="hud">
      <div class="bar" id="bHunger"><h3>Faim</h3><div class="meter"><i style="width:60%"></i></div></div>
      <div class="bar" id="bFun"><h3>Fun</h3><div class="meter"><i style="width:60%"></i></div></div>
      <div class="bar" id="bHyg"><h3>HygiÃ¨ne</h3><div class="meter"><i style="width:60%"></i></div></div>
      <div class="bar" id="bEnergy"><h3>Ã‰nergie</h3><div class="meter"><i style="width:60%"></i></div></div>
    </div>
    <div class="traits" id="traits">
      <span class="chip" id="tAff">Affection: 0</span>
      <span class="chip" id="tDis">Discipline: 0</span>
      <span class="chip" id="tOdo">Odeur: 0</span>
    </div>

    <div class="state" id="state"></div>
    <div class="flash" id="flash"></div>

    <div class="center">
      <svg class="sprite wobble" viewBox="0 0 200 200" id="sprite" aria-label="Cacamochi">
        <ellipse cx="100" cy="170" rx="60" ry="12" fill="var(--shadow)"/>
        <image id="evo-img" href="" x="0" y="0" width="200" height="200" preserveAspectRatio="xMidYMid meet"/>
        <g class="steam" id="steam" stroke="#8a6e3a" stroke-width="2" opacity=".6">
          <line x1="60" y1="70" x2="60" y2="46"/><line x1="100" y1="60" x2="100" y2="36"/><line x1="140" y1="70" x2="140" y2="46"/>
        </g>
        <g class="flies" id="flies" opacity=".9">
          <g transform="translate(100,105)">
            <g transform="rotate(0) translate(46,0)"><circle cx="0" cy="0" r="3" fill="#2a2a2a"/></g>
            <g transform="rotate(140) translate(46,0)"><circle cx="0" cy="0" r="3" fill="#2a2a2a"/></g>
          </g>
        </g>
      </svg>
    </div>

    <div class="actions">
      <button id="feed">ğŸ— Nourrir</button>
      <button id="play">ğŸ² Jouer</button>
      <button id="wash">ğŸ§¼ Laver</button>
      <button id="toilet">ğŸ§» Toilettes</button>
      <button id="sleep">ğŸŒ™ Dodo</button>

      <button id="pet">ğŸ¤² Caresser</button>
      <button id="mystery">ğŸ Snack mystÃ¨re</button>
      <button id="dance">ğŸª© Danse</button>
      <button id="heal">ğŸ’Š Soigner</button>
      <button id="hunt">ğŸª° Chasseâ€‘mouches</button>

      <button id="photo">ğŸ“¸ Photo</button>
      <button id="sound">ğŸ”ˆ Son: OFF</button>
      <button id="save">ğŸ’¾ Sauver</button>
      <button id="reset">ğŸ—‘ï¸ Repartir</button>
    </div>

    <div class="modal" id="modal">
      <div class="panel">
        <button class="close" id="close">âœ–</button>
        <h2>Chasseâ€‘mouches â€” 20â€¯s ! <span class="score" id="score">0</span></h2>
        <div class="arena" id="arena"></div>
      </div>
    </div>
  </main>

  <footer></footer>
</div>

<script>
(()=> {
  const CONFIG = {
    background: "img_background.jpg",
    sprites: {
      bouseau:   { src: "img_bouseau.png",   x:0,y:0,w:200,h:200 },
      cacabra:   { src: "img_cacabra.png",   x:0,y:0,w:200,h:200 },
      seigneur:  { src: "img_seigneur.png",  x:0,y:0,w:200,h:200 },
      skatour:   { src: "img_skatour.png",   x:0,y:0,w:200,h:200 },
      skalibur:  { src: "img_skalibur.png",  x:0,y:0,w:200,h:200 },
      crottombe: { src: "img_crottombe.png", x:0,y:0,w:200,h:200 },
      thanabouse:{ src: "img_thanabouse.png",x:0,y:0,w:200,h:200 },
    }
  };

  const $ = (s, r=document)=> r.querySelector(s);
  const app = { hunger:70, fun:70, hyg:70, energy:70, day:1, alive:true, asleep:false,
                evo:"bouseau", affection:0, discipline:0, odor:0, sound:false };

  // refs
  const bar = { hunger: $("#bHunger .meter i"), fun: $("#bFun .meter i"),
                hyg: $("#bHyg .meter i"), energy: $("#bEnergy .meter i") };
  const bars={ hunger:$("#bHunger"), fun:$("#bFun"), hyg:$("#bHyg"), energy:$("#bEnergy") };
  const age=$("#age"), state=$("#state"), flashEl=$("#flash");
  const bg=$("#bg"), sprite=$("#sprite"), evoImg=$("#evo-img"), steam=$("#steam"), flies=$("#flies");
  const traitsEls={aff:$("#tAff"), dis:$("#tDis"), odo:$("#tOdo")};

  const evoName = id => ({bouseau:"Bouseau",cacabra:"Cacabra",seigneur:"SeignÅ“ur",skatour:"Skatour",skalibur:"Skalibur",crottombe:"Crottombe",thanabouse:"Thanabouse"}[id]||"???");

  // tiny "bip" synth
  let ac=null; function beep(freq=880, dur=0.08){
    if(!app.sound) return;
    if(!ac){ try{ ac=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ return; } }
    const o=ac.createOscillator(), g=ac.createGain();
    o.connect(g); g.connect(ac.destination);
    o.type="square"; o.frequency.value=freq;
    g.gain.setValueAtTime(0.12, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+dur);
    o.start(); o.stop(ac.currentTime+dur);
  }

  // assets
  function applyBackground(){ if(CONFIG.background) bg.src = CONFIG.background; }
  function applySprite(){
    const s = CONFIG.sprites[app.evo]; if(!s) return;
    evoImg.setAttribute("href", s.src);
    evoImg.setAttribute("x", s.x ?? 0); evoImg.setAttribute("y", s.y ?? 0);
    evoImg.setAttribute("width", s.w ?? 200); evoImg.setAttribute("height", s.h ?? 200);
  }

  // state helpers
  function setMeter(name,val){
    val=Math.max(0,Math.min(100,val));
    bar[name].style.width=val+"%";
    bars[name].classList.toggle('bad',val<35);
    bars[name].classList.toggle('mid',val>=35&&val<65);
    bars[name].classList.toggle('good',val>=65);
    app[name]=val;
  }
  function setTrait(name,delta,min=-999,max=999){ app[name]=Math.max(min,Math.min(max,app[name]+delta)); }
  function avg(...xs){return xs.reduce((a,b)=>a+b,0)/xs.length;}
  function flash(txt){ const el=document.createElement('span'); el.className="label"; el.textContent=txt; state.appendChild(el); setTimeout(()=>el.remove(),1600); }
  function boom(){ flashEl.classList.add('on'); sprite.classList.add('shake'); setTimeout(()=>{flashEl.classList.remove('on');sprite.classList.remove('shake');},560); }
  function updateAll(){
    setMeter('hunger',app.hunger); setMeter('fun',app.fun); setMeter('hyg',app.hyg); setMeter('energy',app.energy);
    traitsEls.aff.textContent="Affection: "+app.affection; traitsEls.dis.textContent="Discipline: "+app.discipline; traitsEls.odo.textContent="Odeur: "+app.odor;
    steam.style.opacity=(1-app.hyg/100)*0.9+0.1; flies.style.opacity=(1-app.hyg/100)*0.9+0.1;
    age.textContent=`Jour ${app.day} â€” ${evoName(app.evo)}`;
    applySprite();
  }

  // persistence
  const load=()=>{ try{const s=JSON.parse(localStorage.getItem("cacamochi-v3")); if(s) Object.assign(app,s);}catch(e){} };
  const save=()=>{ localStorage.setItem("cacamochi-v3", JSON.stringify(app)); flash("SauvÃ© !"); beep(1320,.06); };

  // actions
  $("#feed").addEventListener('click',()=>{ if(!app.alive) return;
    setMeter('hunger',app.hunger+22); setMeter('hyg',app.hyg-6); setMeter('energy',app.energy+6);
    setTrait('affection',+1); setTrait('odor',+1); sprite.classList.add('wobble'); setTimeout(()=>sprite.classList.remove('wobble'),10); beep(660,.08); updateAll();
  });
  $("#play").addEventListener('click',()=>{ if(!app.alive) return;
    setMeter('fun',app.fun+18); setMeter('energy',app.energy-10); setMeter('hyg',app.hyg-7);
    setTrait('discipline',+1); setTrait('odor',+1); beep(880,.08); updateAll();
  });
  $("#wash").addEventListener('click',()=>{ if(!app.alive) return;
    setMeter('hyg',app.hyg+30); setTrait('odor',-3); sprite.classList.add('wash'); setTimeout(()=>sprite.classList.remove('wash'),2100); beep(1320,.06); updateAll();
  });
  $("#toilet").addEventListener('click',()=>{ if(!app.alive) return;
    setMeter('hyg',app.hyg+40); setTrait('odor',-6); flash("ğŸ§» Fiuuut !"); beep(420,.08); updateAll();
  });
  $("#sleep").addEventListener('click',()=>{ if(!app.alive) return; app.asleep=!app.asleep; flash(app.asleep?"Bonne nuit...":"RÃ©veil !"); beep(520,.06); updateAll(); });
  $("#dance").addEventListener('click',()=>{ if(!app.alive) return; sprite.classList.add('dance'); setTimeout(()=>sprite.classList.remove('dance'),2800); setMeter('fun',app.fun+10); setMeter('energy',app.energy-6); beep(700,.06); updateAll(); });
  $("#heal").addEventListener('click',()=>{ if(!app.alive) return;
    const low = ['hunger','fun','hyg','energy'].map(k=>app[k]).some(v=>v<35);
    if(low){ setMeter('hunger',app.hunger+8); setMeter('fun',app.fun+8); setMeter('hyg',app.hyg+8); setMeter('energy',app.energy+8); flash("ğŸ’Š Ã‡a va mieux."); beep(990,.08); }
    else { flash("ğŸ’Š Pas besoin pour le moment."); }
    updateAll();
  });
  $("#deodorize")?.addEventListener('click',()=>{ /* laissÃ© si tu veux remettre le bouton un jour */ });

  $("#mystery").addEventListener('click',()=>{ if(!app.alive) return;
    const r=Math.random();
    if(r<.34){ setMeter('fun',app.fun+20); setTrait('affection',+2); flash("ğŸˆ Surprise joyeuse !"); beep(1180,.08); }
    else if(r<.67){ setMeter('hyg',app.hyg-15); setTrait('odor',+4); flash("ğŸ¤¢ Beurk..."); beep(280,.1); }
    else { setMeter('energy',app.energy+18); setTrait('discipline',-1); flash("âš¡ Boost !"); beep(1040,.07); }
    updateAll();
  });

  // caresser (drag)
  (()=>{ let pet=false, lastY=0, score=0, t=null;
    const start=y=>{ pet=true; lastY=y; score=0; t=setTimeout(()=>{ flash("ğŸ¤² +Affection"); setTrait('affection',+2); setMeter('fun',app.fun+6); beep(1100,.06); updateAll(); },800); };
    const move=y=>{ if(!pet) return; if(Math.abs(y-lastY)>10){ score++; lastY=y; } };
    const end=()=>{ if(!pet) return; pet=false; if(t) clearTimeout(t); if(score>6){ setTrait('affection',+1); setMeter('fun',app.fun+4); beep(950,.06); updateAll(); } };
    const area=$("#sprite");
    area.addEventListener('mousedown',e=>start(e.clientY));
    area.addEventListener('mousemove',e=>move(e.clientY));
    window.addEventListener('mouseup',end);
    area.addEventListener('touchstart',e=>start(e.touches[0].clientY),{passive:true});
    area.addEventListener('touchmove',e=>move(e.touches[0].clientY),{passive:true});
    window.addEventListener('touchend',end);
    $("#pet").addEventListener('click',()=>flash("Astuceâ€¯: cliqueâ€‘glisse sur le Cacamochi pour le caresser."));
  })();

  // minigame
  const modal=$("#modal"), arena=$("#arena"), scoreEl=$("#score"); let mgTimer=null, mgTtl=0, mgScore=0;
  function spawnFly(){ const f=document.createElement('div'); f.className="fly";
    const x=Math.random()*(arena.clientWidth-26), y=Math.random()*(arena.clientHeight-20);
    f.style.left=x+"px"; f.style.top=y+"px"; const life=800+Math.random()*1000;
    f.addEventListener('click',()=>{ mgScore++; scoreEl.textContent=mgScore; f.remove(); beep(1200,.05); });
    arena.appendChild(f); setTimeout(()=>f.remove(),life);
  }
  function startHunt(){ modal.classList.add('on'); mgScore=0; scoreEl.textContent="0"; mgTtl=20; arena.innerHTML="";
    mgTimer=setInterval(()=>{ if(mgTtl<=0){ endHunt(); return; } mgTtl--; for(let i=0;i<1+Math.floor(Math.random()*3);i++) spawnFly(); },1000);
  }
  function endHunt(){ clearInterval(mgTimer); mgTimer=null; setTimeout(()=>{ modal.classList.remove('on'); arena.innerHTML=""; rewardHunt(); },600); }
  function rewardHunt(){ const s=mgScore;
    if(s>=20){ setMeter('fun',app.fun+24); setTrait('discipline',+4); flash("ğŸ… MaÃ®tre moucheur !"); }
    else if(s>=10){ setMeter('fun',app.fun+16); setTrait('discipline',+2); flash("ğŸ‘ Bonne chasse !"); }
    else { setMeter('fun',app.fun+8); setTrait('discipline',+1); flash("ğŸ‘ Pas mal."); }
    setTrait('odor',-2); updateAll();
  }
  $("#hunt").addEventListener('click',()=>{ if(app.alive) startHunt(); });
  $("#close").addEventListener('click',()=>{ modal.classList.remove('on'); if(mgTimer){clearInterval(mgTimer); mgTimer=null;} });

  // random events
  setInterval(()=>{ if(!app.alive) return;
    const r=Math.random();
    if(r<.18){ flash("Une mouche sâ€™est posÃ©e..."); setMeter('hyg',app.hyg-4); setTrait('odor',+1); updateAll(); }
    else if(r<.28){ flash("Petit rot discret."); setMeter('hunger',app.hunger+3); setTrait('odor',+1); updateAll(); }
  }, 30000);

  // time & evolution
  function tick(){ if(!app.alive) return;
    const k=app.asleep?0.45:1;
    setMeter('hunger',app.hunger-0.6*k); setMeter('fun',app.fun-0.45*k); setMeter('hyg',app.hyg-0.35*k); setMeter('energy',app.energy-(app.asleep?-0.9:0.7));
    if(['hunger','fun','hyg','energy'].filter(x=>app[x]<=0).length>=2){ app.alive=false; flash("ğŸ’€ RIP Cacamochi..."); disableActions(true); }
    $("#sprite .flies").style.animationDuration=(5+Math.random()*3).toFixed(1)+"s";
    updateAll();
  }
  function newDay(){ if(!app.alive) return; app.day++; flash("â˜€ï¸ Jour "+app.day);
    setMeter('hyg',app.hyg-5); setMeter('hunger',app.hunger-6); evolveCheck(); save(); updateAll();
  }
  setInterval(tick,1200); setInterval(newDay, 1.2*60*1000);

  function evolveCheck(){
    const mood=avg(app.hunger,app.fun,app.hyg,app.energy);
    const clean=app.hyg - app.odor*1.5;
    const playful=app.fun + app.affection;
    const stoic=app.energy - app.discipline*0.5;
    if(app.day>=2 && app.evo==="bouseau"){
      if(clean>=60 && playful>=60) evolveTo("cacabra");
      else if(playful>=65 && clean<60) evolveTo("skatour");
      else if(stoic<45) evolveTo("crottombe");
    }
    if(app.day>=4){
      if(app.evo==="cacabra"   && mood>78 && app.discipline>=4) evolveTo("seigneur");
      if(app.evo==="skatour"   && playful>80)                  evolveTo("skalibur");
      if(app.evo==="crottombe" && (clean<45 || app.energy<40)) evolveTo("thanabouse");
    }
  }
  function evolveTo(next){ if(app.evo===next) return; app.evo=next; boom(); flash(`âœ¨ Ã‰volution : ${evoName(next)} !`); beep(1500,.09); applySprite(); }

  function disableActions(dis){ ["feed","play","wash","toilet","sleep","pet","mystery","dance","heal","hunt","photo","sound","save"].forEach(id=>$("#"+id).disabled=dis); }

  // sound toggle
  $("#sound").addEventListener('click',()=>{ app.sound=!app.sound; $("#sound").textContent = app.sound ? "ğŸ”Š Son: ON" : "ğŸ”ˆ Son: OFF"; beep(900,.06); });

  // save/reset
  $("#save").addEventListener('click',save);
  $("#reset").addEventListener('click',()=>{ localStorage.removeItem("cacamochi-v3"); Object.assign(app,{
    hunger:70,fun:70,hyg:70,energy:70,day:1,alive:true,asleep:false,evo:"bouseau",affection:0,discipline:0,odor:0,sound:app.sound
  }); disableActions(false); flash("Nouveau dÃ©part !"); updateAll(); });

  // photo export (background + sprite en PNG)
  $("#photo").addEventListener('click',()=>{
    try{
      const canvas=document.createElement('canvas');
      canvas.width = Math.min(1920, document.body.clientWidth*2);
      canvas.height= Math.min(1080, document.body.clientHeight*2);
      const ctx=canvas.getContext('2d');

      // draw background
      const bgi=new Image(); bgi.crossOrigin="anonymous"; bgi.onload=()=>{
        // cover
        const cw=canvas.width,ch=canvas.height, iw=bgi.width, ih=bgi.height;
        const scale=Math.max(cw/iw, ch/ih); const nw=iw*scale, nh=ih*scale;
        ctx.drawImage(bgi,(cw-nw)/2,(ch-nh)/2,nw,nh);

        // draw sprite (centered)
        const s=CONFIG.sprites[app.evo]; const si=new Image(); si.crossOrigin="anonymous"; si.onload=()=>{
          const sw = Math.min(cw*0.22, 420), sh = sw; // square-ish
          ctx.drawImage(si, (cw-sw)/2, (ch-sh)/2 - 20, sw, sh);

          const url=canvas.toDataURL("image/png");
          const a=document.createElement('a'); a.href=url; a.download=`cacamochi_j${app.day}_${app.evo}.png`; a.click();
          beep(1300,.06); flash("ğŸ“¸ Photo enregistrÃ©e");
        };
        si.src=s.src;
      };
      bgi.src = CONFIG.background;
    }catch(e){ flash("ğŸ“¸ DÃ©solÃ©, export non supportÃ© ici."); }
  });

  // init
  applyBackground(); load(); updateAll();
})();
</script>
</body>
</html>
