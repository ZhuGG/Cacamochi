<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Cacamochi â€” mobile (PNG + Flies Arcade v2)</title>
<style>
  :root{
    --rose:#f7e4e1; --rose-2:#f3d5cf; --rose-3:#eec0b6;
    --marron:#7b5644; --marron-2:#5b3d31; --txt:#2a1d16;
    --glass:#ffffffd8; --shadow:#00000028;
    --track:#e9d8d3; --fill-good:#8fd09b; --fill-mid:#f2b088; --fill-bad:#e27d7d;
    --btn:#ffe7e2; --btnOn:#ffd2c7; --icon:#7c5542;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--rose);color:var(--txt);overflow-x:hidden;
    font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  .app{min-height:100%;display:grid;grid-template-rows:auto 1fr}

  /* Header */
  header{display:flex;align-items:center;gap:.7rem;padding:.7rem .9rem;
    background:linear-gradient(180deg,var(--rose-2),var(--rose))}
  .brand img{height:32px;width:auto;display:block}
  .age{margin-left:auto;background:var(--glass);backdrop-filter:blur(6px);
    padding:.25rem .6rem;border-radius:999px;box-shadow:0 2px 6px var(--shadow);
    font-weight:800;font-size:.85rem;color:var(--marron)}

  /* Stage */
  .stage{position:relative;overflow:hidden}
  .bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:contrast(1.03) brightness(1.02)}
  /* Ambiance: poussiÃ¨res et bulles trÃ¨s lÃ©gÃ¨res */
  .ambient{position:absolute;inset:0;pointer-events:none;z-index:1}
  .dust{position:absolute;width:3px;height:3px;background:#ffffff99;border-radius:50%;
        animation:float 18s linear infinite;filter:blur(.4px)}
  @keyframes float{from{transform:translateY(0)}to{transform:translateY(-120vh)}}
  .bubbles .bub{position:absolute;width:6px;height:6px;border-radius:50%;
        background:radial-gradient(circle at 30% 30%,#ffffffcc 0,#ffffff55 70%,transparent 72%);
        animation:rise 16s linear infinite;filter:blur(.2px)}
  @keyframes rise{from{transform:translateY(0)}to{transform:translateY(-110vh)}}

  .center{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;z-index:2}
  .sprite{width:clamp(180px,48vw,340px);pointer-events:auto;filter:drop-shadow(0 16px 12px var(--shadow));touch-action:none}
  .wobble{animation:wobble 2.4s ease-in-out infinite}
  @keyframes wobble{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-3%) scale(1.02)}}
  .wash{animation:wash .7s ease-in-out 3}
  @keyframes wash{0%{filter:hue-rotate(0)}50%{filter:hue-rotate(90deg) saturate(1.2)}100%{filter:hue-rotate(0)}}
  .dance{animation:dance .7s ease-in-out 4}
  @keyframes dance{0%{transform:translateX(0) rotate(0)}25%{transform:translateX(-8%) rotate(-6deg)}
    50%{transform:translateX(0) rotate(0)}75%{transform:translateX(8%) rotate(6deg)}100%{transform:translateX(0) rotate(0)}}

  /* HUD */
  .hud{position:absolute;top:.6rem;left:50%;transform:translateX(-50%);
    width:min(94vw,560px);display:grid;grid-template-columns:1fr 1fr;gap:.6rem;
    background:var(--glass);backdrop-filter:blur(8px);padding:.7rem;border-radius:18px;
    box-shadow:0 6px 22px var(--shadow);z-index:5}
  .bar h3{margin:0 0 .28rem 0;font-size:.92rem;color:var(--marron)}
  .meter{height:12px;background:var(--track);border-radius:99px;overflow:hidden}
  .meter>i{display:block;height:100%;width:50%;background:var(--fill-good);transition:width .26s}
  .bad>i{background:var(--fill-bad)} .mid>i{background:var(--fill-mid)}
  .chips{position:absolute;top:calc(.6rem + 108px);left:50%;transform:translateX(-50%);
    display:flex;gap:.45rem;flex-wrap:wrap;max-width:94vw;justify-content:center;z-index:5}
  .chip{background:var(--glass);backdrop-filter:blur(6px);padding:.35rem .7rem;border-radius:999px;
    font-size:.86rem;font-weight:800;color:var(--marron);box-shadow:0 2px 6px var(--shadow)}

  /* Odeur/mouches autour du sprite (ambient) */
  .steam line{animation:steam 3.2s ease-in-out infinite}
  @keyframes steam{0%{opacity:0;transform:translateY(8px)}20%{opacity:.9}100%{opacity:0;transform:translateY(-26px)}}
  .orbitFlies .f{transform-origin:100px 105px;animation:flyOrbit linear infinite}
  .orbitFlies .f > circle{animation:wing .9s ease-in-out infinite}
  @keyframes flyOrbit{from{transform:rotate(0) translate(var(--r)) rotate(0)}to{transform:rotate(360deg) translate(var(--r)) rotate(-360deg)}}
  @keyframes wing{0%,100%{r:3px}50%{r:2px}}

  /* Nuit */
  .sleepOverlay{position:absolute;inset:0;pointer-events:none;opacity:0;transition:opacity .35s;z-index:3}
  .sleeping .sleepOverlay{opacity:1}
  .sleepOverlay .tint{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 60%,#143a6a33 0%,#0822458a 60%,#061a3666 100%)}
  .stars{position:absolute;inset:0;overflow:hidden}
  .star{position:absolute;width:3px;height:3px;background:#d8e7ff;border-radius:50%;opacity:.9;animation:tw 2.2s ease-in-out infinite}
  @keyframes tw{0%,100%{transform:scale(1)}50%{transform:scale(1.6)}}
  .zzz{position:absolute;left:50%;top:38%;transform:translateX(-50%);
    font:800 18px/1.2 system-ui;color:#cfe3ff;animation:zzz 2.6s ease-in-out infinite}
  @keyframes zzz{0%{opacity:0;transform:translate(-50%,6px)}25%{opacity:1}100%{opacity:0;transform:translate(-50%,-18px)}}

  /* Bulle notification */
  .speech{position:absolute;left:50%;top:22%;transform:translateX(-50%);z-index:6;pointer-events:none}
  .speech .b{background:var(--glass);backdrop-filter:blur(8px);padding:.5rem .7rem;border-radius:14px;
    box-shadow:0 6px 18px var(--shadow);font-weight:800;color:var(--marron)}
  .speech .t{width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:10px solid var(--glass);margin:auto}

  /* Disco overlay */
  #disco{position:absolute;inset:0;pointer-events:none;opacity:0;transition:opacity .2s;z-index:4}
  #disco::before,#disco::after{
    content:"";position:absolute;inset:-30%;background:
      radial-gradient(circle at 20% 30%, #ff9cf780 0, transparent 35%),
      radial-gradient(circle at 80% 60%, #7ae7ff80 0, transparent 35%),
      radial-gradient(circle at 50% 80%, #ffe77080 0, transparent 35%);
    filter:blur(12px);mix-blend-mode:screen;animation:spin 6s linear infinite}
  #disco::after{animation-direction:reverse;opacity:.8}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  .disco-on #disco{opacity:.9}

  /* Particules Ã©volution */
  #evolveFX{position:absolute;inset:0;pointer-events:none;z-index:7}
  .fx{position:absolute;width:10px;height:10px;border-radius:50%;
      background:radial-gradient(circle,#fff 0,#ffd9ee 60%,transparent 70%);animation:boom 900ms ease-out forwards}
  @keyframes boom{0%{transform:translate(0,0) scale(.4);opacity:1}100%{transform:var(--tr) scale(1.2);opacity:0}}

  /* Dock */
  .dockWrap{position:absolute;left:0;right:0;bottom:.7rem;z-index:10;padding:0 .7rem;overflow-x:auto;
    -webkit-overflow-scrolling:touch;scrollbar-width:none;
    mask-image:linear-gradient(90deg,transparent 0,#000 20px,#000 calc(100% - 20px),transparent 100%)}
  .dockWrap::-webkit-scrollbar{display:none}
  .dock{display:flex;gap:.55rem;min-width:max-content;scroll-snap-type:x mandatory}
  .btn{scroll-snap-align:center;width:72px;height:72px;border-radius:18px;border:none;background:var(--btn);
    box-shadow:0 8px 18px var(--shadow);display:flex;flex-direction:column;align-items:center;justify-content:center;
    touch-action:manipulation;}
  .btn:active{transform:translateY(2px);background:var(--btnOn)}
  .ico{width:22px;height:22px;display:block;object-fit:contain}
  .lbl{margin-top:4px;font-size:.72rem;font-weight:800;color:var(--marron)}

  /* Boutons scÃ¨ne */
  .gameBtn{position:absolute;z-index:8;width:62px;height:62px;border-radius:50%;border:none;background:var(--btn);
    box-shadow:0 8px 18px var(--shadow);display:flex;flex-direction:column;align-items:center;justify-content:center}
  .gameBtn .ico{width:22px;height:22px} .gameBtn .lbl{font-size:.7rem;margin-top:2px;color:var(--marron)}
  .gameBtn.flies{left:.8rem;top:48%} .gameBtn.bath{right:.8rem;top:48%}

  /* Modals + gameover */
  .modal{position:absolute;inset:0;background:#0007;display:none;align-items:center;justify-content:center;z-index:20}
  .modal.on{display:flex}
  .panelMG{width:min(520px,92vw);height:min(420px,80vh);background:#fff6f4;border-radius:16px;box-shadow:0 10px 30px #0006;position:relative;overflow:hidden;border:3px solid var(--rose-3)}
  .panelHead{display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
  .panelHead h2{margin:0;font-size:16px;color:var(--marron)} .panelHead .score{font-weight:800;color:var(--marron)}
  .close{border:none;background:#0000;font-size:18px;line-height:1;cursor:pointer;color:var(--marron)}
  .arena{position:absolute;inset:56px 12px 14px 12px;border-radius:12px;overflow:hidden}
  .arena.bath{background:#f6eaf0} .arena.flygame{background:#eaf7e6}
  .hit{position:absolute;width:24px;height:24px;border:3px solid #fff;border-radius:999px;opacity:.9;animation:hit .35s ease-out forwards}
  @keyframes hit{to{transform:scale(2);opacity:0}}
  .splat{position:absolute;width:22px;height:22px;background:radial-gradient(circle,#000 0,transparent 70%);border-radius:50%;opacity:.15;animation:splat .5s ease-out forwards}
  @keyframes splat{to{transform:scale(2);opacity:0}}
  .gameover{position:absolute;inset:0;background:#0007;display:none;align-items:center;justify-content:center;z-index:30}
  .gameover.on{display:flex}
  .goPanel{background:#fff2f0;border:3px solid var(--rose-3);width:min(520px,90vw);border-radius:18px;padding:22px;box-shadow:0 12px 30px #0007;text-align:center}
  .goPanel h2{margin:.2rem 0;color:var(--marron);font-size:1.4rem}
  .goPanel p{margin:.2rem 0 .8rem;color:var(--marron)}
  .goPanel button{background:var(--btn);border:none;border-radius:12px;padding:.7rem 1rem;font-weight:800;color:var(--marron-2);box-shadow:0 6px 14px var(--shadow)}

  /* ------- Miniâ€‘jeu MOUCHES â€“ sprites PNG ------- */
  .flySprite{position:absolute;will-change:transform;pointer-events:auto;
    width:38px;height:30px;transform:translate(-50%,-50%) rotate(0deg)}
  .flySprite.small{width:32px;height:26px}
  .flySprite.big{width:46px;height:36px}
  .flySprite.gold{width:40px;height:30px}
  .splatFX,.sparkFX{position:absolute;transform:translate(-50%,-50%)}
  .splatFX{width:24px;height:24px;opacity:.9;animation:splatFX .4s ease-out forwards}
  @keyframes splatFX{to{transform:translate(-50%,-50%) scale(1.8);opacity:0}}
  .sparkFX{width:18px;height:18px;animation:spark .6s ease-out forwards}
  @keyframes spark{to{transform:translate(-50%,-50%) scale(1.8);opacity:0}}

  /* Cible visible (Cacamochi) + timer */
  .arena.flygame{background:#eaf7e6; position:relative}
  .target{position:absolute; left:50%; top:60%; transform:translate(-50%,-50%); pointer-events:none}
  .target img{width:140px; max-width:40vw; opacity:.9;
    filter:drop-shadow(0 10px 12px #0002)}
  .target .ring{position:absolute; left:50%; top:65%;
    width:120px; height:120px; transform:translate(-50%,-50%);
    border:3px dashed #f2b088; border-radius:50%; opacity:.8;
    animation:pulse 1.8s ease-in-out infinite}
  @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(1)}
    50%{transform:translate(-50%,-50%) scale(1.06)}}

  .timer{position:absolute; left:12px; right:12px; top:12px;
    height:10px; background:#ffe7e2; border-radius:999px; overflow:hidden;
    box-shadow:inset 0 2px 6px #00000014}
  .timer i{display:block; height:100%; width:100%;
    background:linear-gradient(90deg,#8fd09b,#f2b088,#e27d7d)}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="brand"><img src="img/header/logo_cacamochi.png" alt="Cacamochi"></div>
    <div class="age" id="age">Jour 1 â€” Bouseau</div>
  </header>

  <main class="stage" id="room">
    <img id="bg" class="bg" alt="PiÃ¨ce" src=""/>
    <!-- ambiance -->
    <div class="ambient" aria-hidden="true">
      <div class="bubbles" id="ambBub"></div>
      <div class="dusts" id="ambDust"></div>
    </div>

    <div class="hud">
      <div class="bar" id="bHunger"><h3>Faim</h3><div class="meter"><i></i></div></div>
      <div class="bar" id="bFun"><h3>Fun</h3><div class="meter"><i></i></div></div>
      <div class="bar" id="bHyg"><h3>HygiÃ¨ne</h3><div class="meter"><i></i></div></div>
      <div class="bar" id="bEnergy"><h3>Ã‰nergie</h3><div class="meter"><i></i></div></div>
    </div>
    <div class="chips">
      <span class="chip" id="tAff">Affection: 0</span>
      <span class="chip" id="tDis">Discipline: 0</span>
      <span class="chip" id="tOdo">Odeur: 0</span>
    </div>

    <div class="speech" id="speech" style="display:none"><div class="b" id="speechText">Hi!</div><div class="t"></div></div>
    <div id="disco" aria-hidden="true"></div>
    <div id="evolveFX" aria-hidden="true"></div>
    <div class="sleepOverlay" id="sleepOverlay"><div class="tint"></div><div class="stars" id="stars"></div><div class="zzz">Z z z ...</div></div>

    <!-- Sprite -->
    <div class="center">
      <svg class="sprite wobble" viewBox="0 0 200 200" id="sprite" aria-label="Cacamochi">
        <ellipse cx="100" cy="170" rx="60" ry="12" fill="#00000022"/>
        <image id="evo-img" href="" x="0" y="0" width="200" height="200" preserveAspectRatio="xMidYMid meet"/>
        <g class="steam" id="steam" stroke="#8a6e3a" stroke-width="2" opacity=".6">
          <line x1="60" y1="70" x2="60" y2="46"/><line x1="100" y1="60" x2="100" y2="36"/><line x1="140" y1="70" x2="140" y2="46"/>
        </g>
        <g class="orbitFlies" id="orbitFlies" opacity=".95">
          <g class="f" style="--r:45px; animation-duration:7s"><circle cx="100" cy="105" r="3" fill="#2a2a2a"/></g>
          <g class="f" style="--r:52px; animation-duration:6s"><circle cx="100" cy="105" r="3" fill="#2a2a2a"/></g>
          <g class="f" style="--r:40px; animation-duration:8s"><circle cx="100" cy="105" r="3" fill="#2a2a2a"/></g>
          <g class="f" style="--r:58px; animation-duration:5.5s"><circle cx="100" cy="105" r="3" fill="#2a2a2a"/></g>
          <g class="f" style="--r:35px; animation-duration:7.5s"><circle cx="100" cy="105" r="3" fill="#2a2a2a"/></g>
          <g class="f" style="--r:50px; animation-duration:6.7s"><circle cx="100" cy="105" r="3" fill="#2a2a2a"/></g>
        </g>
      </svg>
    </div>

    <!-- Miniâ€‘jeux (scÃ¨ne) -->
    <button type="button" class="gameBtn flies" id="btnFlies">
      <img class="ico" src="img/icons/mouches.png" alt=""><span class="lbl">Mouches</span>
    </button>
    <button type="button" class="gameBtn bath" id="btnBath">
      <img class="ico" src="img/icons/bain.png" alt=""><span class="lbl">Bain</span>
    </button>

    <!-- Dock -->
    <div class="dockWrap">
      <div class="dock" id="dock">
        <button class="btn" id="feed"><img class="ico" src="img/icons/nourrir.png" alt=""><span class="lbl">Nourrir</span></button>
        <button class="btn" id="wash"><img class="ico" src="img/icons/laver.png" alt=""><span class="lbl">Laver</span></button>
        <button class="btn" id="toilet"><img class="ico" src="img/icons/WC.png" alt=""><span class="lbl">WC</span></button>
        <button class="btn" id="sleep"><img class="ico" src="img/icons/dodo.png" alt=""><span class="lbl">Dodo</span></button>
        <button class="btn" id="play"><img class="ico" src="img/icons/jouer.png" alt=""><span class="lbl">Jouer</span></button>
        <button class="btn" id="heal"><img class="ico" src="img/icons/soigner.png" alt=""><span class="lbl">Soigner</span></button>
        <button class="btn" id="snack"><img class="ico" src="img/icons/snack.png" alt=""><span class="lbl">Snack</span></button>
        <button class="btn" id="spray"><img class="ico" src="img/icons/desodoriser.png" alt=""><span class="lbl">DÃ©so</span></button>
        <button class="btn" id="kiss"><img class="ico" src="img/icons/bisou.png" alt=""><span class="lbl">Bisou</span></button>
        <button class="btn" id="nap"><img class="ico" src="img/icons/dodo.png" alt=""><span class="lbl">Sieste</span></button>
      </div>
    </div>

    <!-- Modals jeux -->
    <div class="modal" id="modalBath">
      <div class="panelMG">
        <div class="panelHead"><h2>Bain Mousse â€” 20â€¯s</h2><div class="score" id="scoreBath">0</div><button type="button" class="close" id="closeBath">âœ–</button></div>
        <div class="arena bath" id="arenaBath"></div>
      </div>
    </div>

    <div class="modal" id="modalFlies">
      <div class="panelMG">
        <div class="panelHead">
          <h2>Chasseâ€‘mouches â€” 20â€¯s</h2>
          <div class="score" id="scoreFlies">0</div>
          <button type="button" class="close" id="closeFlies">âœ–</button>
        </div>
        <div class="arena flygame" id="arenaFlies">
          <div class="target" id="mgTargetWrap">
            <img id="mgTarget" alt="Cacamochi cible"/>
            <div class="ring"></div>
          </div>
          <div class="timer" id="mgTimer"><i></i></div>
        </div>
      </div>
    </div>

    <!-- Game Over -->
    <div class="gameover" id="gameover">
      <div class="goPanel">
        <h2>ðŸ’€ Cacamochi est partiâ€¦</h2>
        <p>Tu peux recommencer une nouvelle vie quand tu veux.</p>
        <button type="button" id="restart">Recommencer</button>
      </div>
    </div>
  </main>
</div>

<script>
(()=> {
  const CONFIG = {
    background: "img_background.jpg",
    sprites: {
      bouseau:   { src: "img_bouseau.png",   x:0,y:0,w:200,h:200 },
      cacabra:   { src: "img_cacabra.png",   x:0,y:0,w:200,h:200 },
      seigneur:  { src: "img_seigneur.png",  x:0,y:0,w:200,h:200 },
      skatour:   { src: "img_skatour.png",   x:0,y:0,w:200,h:200 },
      skalibur:  { src: "img_skalibur.png",  x:0,y:0,w:200,h:200 },
      crottombe: { src: "img_crottombe.png", x:0,y:0,w:200,h:200 },
      thanabouse:{ src: "img_thanabouse.png",x:0,y:0,w:200,h:200 }
    }
  };

  const $=(s,r=document)=>r.querySelector(s);
  const app={hunger:70,fun:70,hyg:70,energy:70,day:1,alive:true,asleep:false,
             evo:"bouseau",affection:0,discipline:0,odor:0};

  const bar={ hunger:$("#bHunger .meter i"), fun:$("#bFun .meter i"), hyg:$("#bHyg .meter i"), energy:$("#bEnergy .meter i") };
  const bars={ hunger:$("#bHunger"), fun:$("#bFun"), hyg:$("#bHyg"), energy:$("#bEnergy") };
  const age=$("#age"), speech=$("#speech"), speechText=$("#speechText");
  const bg=$("#bg"), evoImg=$("#evo-img"), sprite=$("#sprite");
  const traitsEls={aff:$("#tAff"), dis:$("#tDis"), odo:$("#tOdo")};
  const stars=$("#stars"), gameover=$("#gameover");

  const evoName=id=>({bouseau:"Bouseau",cacabra:"Cacabra",seigneur:"SeignÅ“ur",skatour:"Skatour",skalibur:"Skalibur",crottombe:"Crottombe",thanabouse:"Thanabouse"}[id]||"???" );

  function say(txt){ speechText.textContent=txt; speech.style.display='block'; clearTimeout(say.t); say.t=setTimeout(()=>speech.style.display='none',1400); }
  function applyBackground(){ bg.src=CONFIG.background; }
  function applySprite(){ const s=CONFIG.sprites[app.evo]; if(!s) return;
    evoImg.setAttribute('href',s.src); evoImg.setAttribute('x',s.x??0); evoImg.setAttribute('y',s.y??0);
    evoImg.setAttribute('width',s.w??200); evoImg.setAttribute('height',s.h??200);
  }
  function setMeter(name,val){ val=Math.max(0,Math.min(100,val)); bar[name].style.width=val+"%";
    bars[name].classList.toggle('bad',val<35); bars[name].classList.toggle('mid',val>=35&&val<65); bars[name].classList.toggle('good',val>=65); app[name]=val; }
  function setTrait(name,delta,min=-999,max=999){ app[name]=Math.max(min,Math.min(max,app[name]+delta)); }
  function avg(...xs){return xs.reduce((a,b)=>a+b,0)/xs.length;}
  function updateAll(){
    setMeter('hunger',app.hunger); setMeter('fun',app.fun); setMeter('hyg',app.hyg); setMeter('energy',app.energy);
    traitsEls.aff.textContent="Affection: "+app.affection; traitsEls.dis.textContent="Discipline: "+app.discipline; traitsEls.odo.textContent="Odeur: "+app.odor;
    age.textContent=`Jour ${app.day} â€” ${evoName(app.evo)}`; applySprite();
    document.body.classList.toggle('sleeping', app.asleep);
    refreshOrbitFlies();
  }
  const load=()=>{ try{const s=JSON.parse(localStorage.getItem("cacamochi-png")); if(s) Object.assign(app,s);}catch(e){} };
  const save=()=>{ localStorage.setItem("cacamochi-png", JSON.stringify(app)); };

  /* ambiance: poussiÃ¨res + bulles */
  (function(){
    const D=$("#ambDust"), B=$("#ambBub");
    for(let i=0;i<28;i++){ const d=document.createElement('div'); d.className='dust';
      d.style.left=(Math.random()*100)+'%'; d.style.bottom='-10vh';
      d.style.animationDelay=(Math.random()*18)+'s'; d.style.opacity=(.2+.6*Math.random());
      D.appendChild(d);
    }
    for(let i=0;i<18;i++){ const b=document.createElement('div'); b.className='bub';
      b.style.left=(Math.random()*100)+'%'; b.style.bottom='-8vh';
      b.style.animationDelay=(Math.random()*14)+'s';
      B.appendChild(b);
    }
  })();

  function refreshOrbitFlies(){
    const dirt = Math.max(0, 100-app.hyg) + Math.max(0, app.odor*5);
    const vis = Math.min(1, dirt/120);
    $("#orbitFlies").style.opacity=(0.2 + vis*0.8).toFixed(2);
  }
  for(let i=0;i<42;i++){ const s=document.createElement('div'); s.className='star';
    s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%'; s.style.animationDelay=(Math.random()*2)+'s'; stars.appendChild(s); }

  /* Actions (dock) */
  $("#feed").addEventListener('click',()=>{ if(!app.alive) return;
    setMeter('hunger',app.hunger+22); setMeter('hyg',app.hyg-6); setMeter('energy',app.energy+6);
    setTrait('affection',+1); setTrait('odor',+1); say("Miam !"); updateAll(); save();
  });
  $("#wash").addEventListener('click',()=>{ if(!app.alive) return;
    setMeter('hyg',app.hyg+30); setTrait('odor',-3); sprite.classList.add('wash');
    setTimeout(()=>sprite.classList.remove('wash'),2100); say("Tout propre !"); updateAll(); save();
  });
  $("#toilet").addEventListener('click',()=>{ if(!app.alive) return;
    setMeter('hyg',app.hyg+40); setTrait('odor',-6); say("ðŸ§» Fiuuut !"); updateAll(); save();
  });
  $("#sleep").addEventListener('click',()=>{ if(!app.alive) return;
    app.asleep=!app.asleep; say(app.asleep?"Bonne nuit...":"RÃ©veil !"); updateAll(); save();
  });
  $("#play").addEventListener('click',()=>{ if(!app.alive) return;
    setMeter('fun',app.fun+16); setMeter('energy',app.energy-8); setTrait('discipline',+1); setTrait('odor',+1);
    say("On joue !"); updateAll(); save();
  });
  $("#heal").addEventListener('click',()=>{ if(!app.alive) return;
    const low=['hunger','fun','hyg','energy'].some(k=>app[k]<35);
    if(low){['hunger','fun','hyg','energy'].forEach(k=>setMeter(k,app[k]+8)); say("ðŸ’Š Ã‡a va mieux.");}
    else say("Pas besoin.");
    updateAll(); save();
  });
  $("#snack").addEventListener('click',()=>{ if(!app.alive) return;
    const r=Math.random();
    if(r<.33){ setMeter('hunger',app.hunger+16); say("Snack salÃ© ðŸ˜‹"); }
    else if(r<.66){ setMeter('fun',app.fun+14); say("Snack sucrÃ© ðŸ¤¤"); }
    else { setMeter('hunger',app.hunger+8); setTrait('odor',+2); say("Snack douteux ðŸ˜¬"); }
    updateAll(); save();
  });
  $("#spray").addEventListener('click',()=>{ if(!app.alive) return;
    setTrait('odor',-6); setMeter('hyg',app.hyg+6); setMeter('energy',app.energy-4);
    say("Pschiiit ! Ã‡a sent bon âœ¨"); updateAll(); save();
  });
  $("#kiss").addEventListener('click',()=>{ if(!app.alive) return;
    setTrait('affection',+3); setMeter('fun',app.fun+6); say("Bisou ðŸ’•"); updateAll(); save();
  });
  $("#nap").addEventListener('click',()=>{ if(!app.alive) return;
    setMeter('energy',app.energy+14); setMeter('fun',app.fun-4); app.asleep=false;
    say("Petite sieste ðŸ˜´"); updateAll(); save();
  });

  /* Dock UX : centre le bouton tapÃ© sans bouger la page */
  const wrap = document.querySelector('.dockWrap');
  document.getElementById('dock').addEventListener('click', e=>{
    const b = e.target.closest('button'); if(!b) return;
    const target = b.offsetLeft - (wrap.clientWidth - b.clientWidth)/2;
    wrap.scrollTo({ left: Math.max(0, target), behavior: 'smooth' });
    setTimeout(()=>b.blur(), 150);
  });

  /* Danse (doubleâ€‘tap) */
  (function(){
    let last=0;
    const s = document.getElementById('sprite');
    s.addEventListener('touchend',()=>{ const now=Date.now(); if(now-last<300){ dance(); } last=now; },{passive:true});
    s.addEventListener('click',()=>{ const now=Date.now(); if(now-last<300){ dance(); } last=now; });
    function dance(){
      if(!app.alive) return;
      document.body.classList.add('disco-on'); s.classList.add('dance');
      setTimeout(()=>{ s.classList.remove('dance'); document.body.classList.remove('disco-on'); }, 2800);
      setMeter('fun',app.fun+10); setMeter('energy',app.energy-6); say("Disco !");
      updateAll(); save();
    }
  })();

  /* Caresser */
  (function(){
    let pet=false, lastX=0,lastY=0, moves=0, timer=null;
    const start=(x,y)=>{ pet=true; lastX=x; lastY=y; moves=0;
      timer=setTimeout(()=>{ if(pet){ setTrait('affection',+2); setMeter('fun',app.fun+6); say("ðŸ¤² +Affection"); updateAll(); save(); } },700);
    };
    const move=(x,y)=>{ if(!pet) return; if(Math.abs(x-lastX)+Math.abs(y-lastY)>14){ moves++; lastX=x; lastY=y; } };
    const end=()=>{ if(!pet) return; pet=false; if(timer) clearTimeout(timer); if(moves>8){ setTrait('affection',+1); setMeter('fun',app.fun+4); say("Il adore !"); updateAll(); save(); } };
    const area=$("#sprite");
    area.addEventListener('touchstart',e=>{const t=e.touches[0]; start(t.clientX,t.clientY);},{passive:true});
    area.addEventListener('touchmove', e=>{const t=e.touches[0]; move(t.clientX,t.clientY);},{passive:true});
    window.addEventListener('touchend', end);
    area.addEventListener('mousedown',e=>start(e.clientX,e.clientY));
    area.addEventListener('mousemove',e=>move(e.clientX,e.clientY));
    window.addEventListener('mouseup',end);
  })();

  /* ===== Miniâ€‘jeu MOUCHES â€” Arcade (cible visible + difficultÃ©) ===== */
  (function(){
    const modal   = document.getElementById('modalFlies');
    const arena   = document.getElementById('arenaFlies');
    const scoreEl = document.getElementById('scoreFlies');
    const btnOpen = document.getElementById('btnFlies');
    const btnClose= document.getElementById('closeFlies');

    const targetWrap = document.getElementById('mgTargetWrap');
    const targetImg  = document.getElementById('mgTarget');
    const timerBar   = document.getElementById('mgTimer').firstElementChild;

    const ASSETS = {
      flySmall: 'img/flies/fly_small.png',
      flyBig:   'img/flies/fly_big.png',
      flyGold:  'img/flies/fly_gold.png',
      splat:    'img/flies/splat.png',
      spark:    'img/flies/spark.png' // peut ne pas exister, fallback gÃ©rÃ©
    };

    let RAF=0, running=false, tStart=0, duration=20000;
    let flies=[], score=0, spawnCoolDown=0;

    function CENTER(){
      const a = arena.getBoundingClientRect();
      const r = targetWrap.getBoundingClientRect();
      return { x: (r.left+r.width/2) - a.left, y: (r.top+r.height/2) - a.top };
    }
    const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
    const rand=(a,b)=> a + Math.random()*(b-a);
    const prog=(t)=> clamp((t - tStart)/duration, 0, 1);
    const spawnInterval=(p)=> 1000 - 650*p;
    const speedMult=(p)=> 0.9 + 0.9*p;
    const goldChance=(p)=> 0.04 + 0.08*p;
    const maxSimultaneous=(p)=> Math.round(3 + 2*p);

    function spawnFly(tNow){
      const p = prog(tNow);
      if(flies.filter(f=>!f.dead).length >= maxSimultaneous(p)) return;

      const w=arena.clientWidth, h=arena.clientHeight;
      const edge=Math.floor(Math.random()*4);
      const m=document.createElement('img');

      const r=Math.random(), isGold=r<goldChance(p);
      let type='small', base=110, hp=1, img=ASSETS.flySmall, pts=1;
      if(!isGold && r>0.75){ type='big'; base=70; hp=2; img=ASSETS.flyBig; pts=2; }
      if(isGold){ type='gold'; base=130; hp=1; img=ASSETS.flyGold; pts=5; }

      m.src=img; m.className=`flySprite ${type}`;
      arena.appendChild(m);

      let x=0,y=0;
      if(edge===0){ x=rand(0,w); y=-24; }
      if(edge===1){ x=w+24; y=rand(0,h); }
      if(edge===2){ x=rand(0,w); y=h+24; }
      if(edge===3){ x=-24;  y=rand(0,h); }

      const fly={el:m,x,y,speed:base*speedMult(p),hp,pts,a:0,dead:false};
      const hit=(ev)=>{
        ev.stopPropagation();
        fly.hp--;
        popEffect(fly.x, fly.y, fly.hp<=0, type==='gold');
        if(fly.hp<=0){ score+=fly.pts; scoreEl.textContent=score; m.remove(); fly.dead=true; }
      };
      m.addEventListener('touchstart',hit,{passive:true});
      m.addEventListener('mousedown',hit);
      flies.push(fly);
    }

    function popEffect(x,y,dead,isGold){
      const fx=document.createElement('img');
      fx.src = dead ? ASSETS.splat : (ASSETS.spark || ASSETS.splat);
      fx.className = dead ? 'splatFX' : 'sparkFX';
      fx.style.left=x+'px'; fx.style.top=y+'px'; arena.appendChild(fx);
      setTimeout(()=>fx.remove(), dead?400:600);
      if(isGold && dead && ASSETS.spark){ const fx2=document.createElement('img'); fx2.src=ASSETS.spark; fx2.className='sparkFX';
        fx2.style.left=(x+10)+'px'; fx2.style.top=(y-10)+'px'; arena.appendChild(fx2); setTimeout(()=>fx2.remove(),600); }
    }

    function loop(t){
      if(!running) return;
      if(!tStart) tStart=t;
      const dt = Math.min(32, t - (loop.prev||t)); loop.prev=t;

      const p = prog(t); timerBar.style.width = (100*(1-p))+'%';

      spawnCoolDown -= dt;
      if(spawnCoolDown<=0){ spawnFly(t); spawnCoolDown = spawnInterval(p); }

      const c=CENTER();
      for(const f of flies){
        if(f.dead) continue;
        const dx=c.x - f.x, dy=c.y - f.y;
        const d = Math.max(1, Math.hypot(dx,dy));
        const vx=f.speed*dx/d*(dt/1000), vy=f.speed*dy/d*(dt/1000);
        const wob = Math.sin((t/120)+f.x*0.03)*0.7;
        f.x += vx + wob; f.y += vy;
        f.a = Math.atan2(dy,dx);
        f.el.style.transform = `translate(${f.x}px,${f.y}px) rotate(${f.a}rad)`;

        if(d < 56){
          if(window.setMeter){ setMeter('hyg', Math.max(0, app.hyg-4)); setTrait('odor', +1); }
          popEffect(f.x, f.y, true, false);
          f.el.remove(); f.dead=true;
        }
      }
      flies = flies.filter(f=>!f.dead);

      if((t - tStart) >= duration){ stop(true); return; }
      RAF = requestAnimationFrame(loop);
    }

    function start(){
      const href = document.getElementById('evo-img').getAttribute('href');
      targetImg.src = href || 'img_bouseau.png';

      score=0; scoreEl.textContent='0';
      flies.length=0; spawnCoolDown=0; tStart=0; loop.prev=0;
      timerBar.style.width='100%';
      running=true; modal.classList.add('on');
      RAF=requestAnimationFrame(loop);
    }

    function stop(withReward){
      running=false; cancelAnimationFrame(RAF);
      flies.forEach(f=>f.el && f.el.remove()); flies.length=0;
      setTimeout(()=>{ modal.classList.remove('on'); }, 200);

      if(withReward){
        if(score>=28){ setMeter('fun', app.fun+24); setTrait('discipline',+4); setTrait('odor',-2); say("MaÃ®tre moucheur !"); }
        else if(score>=14){ setMeter('fun', app.fun+16); setTrait('discipline',+2); setTrait('odor',-2); say("Bonne chasse !"); }
        else { setMeter('fun', app.fun+8); setTrait('discipline',+1); setTrait('odor',-1); say("Pas mal."); }
        updateAll(); save();
      }
    }

    btnOpen.addEventListener('click', ()=>{ if(app.alive) start(); });
    btnClose.addEventListener('click', ()=> stop(false));
    modal.addEventListener('click', e=>{ if(e.target===modal) stop(false); });
  })();

  /* ===== Miniâ€‘jeu BAIN (simple) ===== */
  (function(){
    const modalBath=$("#modalBath"), arenaBath=$("#arenaBath"), scoreBath=$("#scoreBath");
    let tBath=null, scBath=0, timeBath=20;

    function spawnBubble(){
      const f=document.createElement('div'); f.className="hit"; // rÃ©utilise anneau pour feedback
      f.style.borderColor="#fff"; f.style.width="20px"; f.style.height="20px";
      const x=Math.random()*(arenaBath.clientWidth-24)+12, y=arenaBath.clientHeight+20;
      f.style.left=(x-10)+"px"; f.style.top=(y-10)+"px";
      const dur=1200+Math.random()*1200; const start=performance.now();
      function step(t){ const p=(t-start)/dur; if(p>=1){ f.remove(); return; } f.style.top=(y - p*(arenaBath.clientHeight+80) - 10)+"px"; requestAnimationFrame(step); }
      function add(){ scBath++; scoreBath.textContent=scBath; f.remove(); }
      f.addEventListener('click',add); f.addEventListener('touchstart',add,{passive:true});
      arenaBath.appendChild(f); requestAnimationFrame(step);
    }
    function startBath(){ modalBath.classList.add('on'); arenaBath.innerHTML=""; scBath=0; scoreBath.textContent="0"; timeBath=20;
      tBath=setInterval(()=>{ if(timeBath<=0){ endBath(); return; } timeBath--; for(let i=0;i<2+Math.floor(Math.random()*3);i++) spawnBubble(); },1000); }
    function endBath(){ clearInterval(tBath); tBath=null; setTimeout(()=>{ modalBath.classList.remove('on'); arenaBath.innerHTML=""; rewardBath(); },400); }
    function rewardBath(){ const s=scBath;
      if(s>=25){ setMeter('hyg',app.hyg+30); setMeter('fun',app.fun+18); setTrait('odor',-4); say("ðŸ«§ Roi de la mousse !"); }
      else if(s>=12){ setMeter('hyg',app.hyg+20); setMeter('fun',app.fun+12); setTrait('odor',-3); say("ðŸ«§ Bien jouÃ© !"); }
      else { setMeter('hyg',app.hyg+12); setMeter('fun',app.fun+6); setTrait('odor',-2); say("ðŸ«§ Pas mal."); }
      updateAll(); save();
    }
    $("#btnBath").addEventListener('click',()=>{ if(app.alive) startBath(); });
    $("#closeBath").addEventListener('click',()=>{ modalBath.classList.remove('on'); if(tBath){clearInterval(tBath); tBath=null;} });
  })();

  /* Random & temps + Ã©volutions + restart */
  setInterval(()=>{ if(!app.alive) return; const r=Math.random();
    if(r<.18){ say("Une mouche sâ€™est posÃ©e..."); setMeter('hyg',app.hyg-4); setTrait('odor',+1); updateAll(); }
    else if(r<.28){ say("Petit rot discret."); setMeter('hunger',app.hunger+3); setTrait('odor',+1); updateAll(); }
  }, 30000);

  function tick(){ if(!app.alive) return;
    const k=app.asleep?0.45:1;
    setMeter('hunger',app.hunger-0.6*k); setMeter('fun',app.fun-0.45*k); setMeter('hyg',app.hyg-0.35*k);
    setMeter('energy', app.energy-(app.asleep?-0.9:0.7));
    if(['hunger','fun','hyg','energy'].filter(x=>app[x]<=0).length>=2){
      app.alive=false; gameover.classList.add('on'); say("ðŸ’€ RIP Cacamochi...");
    }
    updateAll();
  }
  function newDay(){ if(!app.alive) return; app.day++; say("â˜€ï¸ Jour "+app.day);
    setMeter('hyg',app.hyg-5); setMeter('hunger',app.hunger-6);
    evolveCheck(); save(); updateAll();
  }
  setInterval(tick,1200); setInterval(newDay, 1.2*60*1000);

  function evolveCheck(){
    const mood=avg(app.hunger,app.fun,app.hyg,app.energy);
    const clean=app.hyg - app.odor*1.5, playful=app.fun + app.affection, stoic=app.energy - app.discipline*0.5;
    if(app.day>=2 && app.evo==="bouseau"){
      if(clean>=60 && playful>=60) evolveTo("cacabra");
      else if(playful>=65 && clean<60) evolveTo("skatour");
      else if(stoic<45) evolveTo("crottombe");
    }
    if(app.day>=4){
      if(app.evo==="cacabra"   && mood>78 && app.discipline>=4) evolveTo("seigneur");
      if(app.evo==="skatour"   && playful>80)                  evolveTo("skalibur");
      if(app.evo==="crottombe" && (clean<45 || app.energy<40)) evolveTo("thanabouse");
    }
  }
  function evolveTo(next){
    if(app.evo===next) return;
    app.evo = next;
    const sEl=$("#sprite");
    sEl.style.transition="transform .35s ease, filter .35s ease";
    sEl.style.transform="scale(1.1)";
    sEl.style.filter="drop-shadow(0 28px 24px var(--shadow)) saturate(1.2)";
    setTimeout(()=>{ applySprite(); },120);
    const fx=$("#evolveFX"), rect=sEl.getBoundingClientRect();
    const cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
    for(let i=0;i<36;i++){
      const a=Math.random()*Math.PI*2, d=60+Math.random()*120;
      const dx=Math.cos(a)*d, dy=Math.sin(a)*d;
      const p=document.createElement('div'); p.className='fx';
      p.style.left=(cx-5)+"px"; p.style.top=(cy-5)+"px";
      p.style.setProperty('--tr',`translate(${dx}px,${dy}px)`);
      fx.appendChild(p); setTimeout(()=>p.remove(),900);
    }
    setTimeout(()=>{ sEl.style.transform=""; sEl.style.filter=""; },400);
    say(`âœ¨ Ã‰volution : ${evoName(next)} !`);
  }

  $("#restart").addEventListener('click',()=>{
    Object.assign(app,{hunger:70,fun:70,hyg:70,energy:70,day:1,alive:true,asleep:false,evo:"bouseau",affection:0,discipline:0,odor:0});
    gameover.classList.remove('on'); applySprite(); updateAll(); save();
  });

  applyBackground(); load(); updateAll();
})();
</script>
</body>
</html>
