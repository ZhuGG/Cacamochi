<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cacamochi â€” version images perso</title>
<style>
  :root{ --shadow:#00000024; --good:#5cc45c; --mid:#ffb84d; --bad:#ff5a5a; }
  html,body{height:100%;margin:0;background:#ece8df;font-family:system-ui,Segoe UI,Roboto,Arial}
  .game{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
  header,footer{padding:10px 14px} h1{margin:0;font-size:18px}
  .room-wrap{position:relative;overflow:hidden}
  /* Background image (remplace l'ancien SVG de piÃ¨ce) */
  .room-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:contrast(1.03) brightness(1.02)}
  .stage{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
  .sprite{width:min(36vmin,320px);filter:drop-shadow(0 18px 12px var(--shadow));pointer-events:auto}
  .wobble{animation:wobble 2.4s ease-in-out infinite}
  @keyframes wobble{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-3%) scale(1.02)}}
  .steam line{animation:steam 3.6s ease-in-out infinite}
  @keyframes steam{0%{opacity:0;transform:translateY(8px)}20%{opacity:.9}100%{opacity:0;transform:translateY(-26px)}}
  .flies{animation:orbit 6s linear infinite;transform-origin:center}
  @keyframes orbit{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  .happy{animation:happy .6s ease-in-out 1}@keyframes happy{0%{transform:translateY(0)}40%{transform:translateY(-12%)}100%{transform:translateY(0)}}
  .wash{animation:wash .7s ease-in-out 3}@keyframes wash{0%{filter:hue-rotate(0)}50%{filter:hue-rotate(90deg) saturate(1.2)}100%{filter:hue-rotate(0)}}
  .shake{animation:shake .6s cubic-bezier(.36,.07,.19,.97)}@keyframes shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}
  .flash{position:absolute;inset:0;background:#fff;opacity:0;pointer-events:none}
  .flash.on{animation:flash .6s ease}@keyframes flash{0%{opacity:0}10%{opacity:.9}100%{opacity:0}}
  /* HUD & UI (identique v2) */
  .hud{position:absolute;left:8px;top:8px;display:flex;gap:8px;flex-wrap:wrap}
  .bar{min-width:150px;background:#ffffffbc;border-radius:10px;padding:6px 8px;box-shadow:0 2px 6px #0000001a}
  .bar h3{margin:0 0 4px 0;font-size:12px}
  .meter{height:8px;background:#00000010;border-radius:99px;overflow:hidden}
  .meter>i{display:block;height:100%;width:50%;background:linear-gradient(90deg,var(--good),#9be57a);transition:width .35s}
  .bad>i{background:linear-gradient(90deg,var(--bad),#ff7f7f)}
  .mid>i{background:linear-gradient(90deg,var(--mid),#ffd399)}
  .traits{position:absolute;left:8px;top:88px;display:flex;gap:6px;flex-wrap:wrap}
  .chip{background:#ffffffc8;padding:4px 8px;border-radius:999px;font-size:12px;box-shadow:0 2px 6px #00000014}
  .state{position:absolute;left:8px;bottom:8px;display:flex;gap:8px;flex-wrap:wrap}
  .label{background:#ffffffbf;padding:6px 10px;border-radius:999px;box-shadow:0 2px 6px #00000014;font-weight:700}
  .actions{position:absolute;right:8px;bottom:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  button{cursor:pointer;border:none;border-radius:12px;padding:10px 12px;background:#fff;box-shadow:0 4px 10px #0000001a;font-weight:700}
  button:active{transform:translateY(2px)}
  .modal{position:absolute;inset:0;background:#00000060;display:none;align-items:center;justify-content:center}
  .modal.on{display:flex}
  .panel{width:min(560px,90vw);height:min(360px,70vh);background:#f6f3ee;border-radius:16px;box-shadow:0 10px 30px #00000040;position:relative;overflow:hidden}
  .panel h2{margin:10px 12px;font-size:16px}
  .arena{position:absolute;inset:50px 12px 12px 12px;background:#dfe8c8;border-radius:12px;overflow:hidden;cursor:crosshair}
  .fly{position:absolute;width:26px;height:20px}
  .arena .fly:after{content:"ğŸª°";font-size:20px;line-height:20px}
  .score{position:absolute;right:12px;top:12px;font-weight:800}
  .close{position:absolute;right:10px;top:8px}
  .hidden{display:none}
</style>
</head>
<body>
<div class="game" id="app">
  <header>
    <h1>ğŸ’© Cacamochi</h1>
    <div id="age" class="chip" title="Ã‚ge">Jour 1 â€” Bouseau</div>
    <div id="msg" class="chip">Sprites & background chargÃ©s depuis /img</div>
  </header>

  <main class="room-wrap" id="room">
    <!-- Background image depuis /img -->
    <img id="bg" class="room-img" alt="PiÃ¨ce" src="" />

    <!-- HUD -->
    <div class="hud">
      <div class="bar" id="bHunger"><h3>Faim</h3><div class="meter"><i style="width:60%"></i></div></div>
      <div class="bar" id="bFun"><h3>Fun</h3><div class="meter"><i style="width:60%"></i></div></div>
      <div class="bar" id="bHyg"><h3>HygiÃ¨ne</h3><div class="meter"><i style="width:60%"></i></div></div>
      <div class="bar" id="bEnergy"><h3>Ã‰nergie</h3><div class="meter"><i style="width:60%"></i></div></div>
    </div>
    <div class="traits" id="traits">
      <span class="chip" id="tAff">Affection: 0</span>
      <span class="chip" id="tDis">Discipline: 0</span>
      <span class="chip" id="tOdo">Odeur: 0</span>
    </div>

    <!-- STATE / FLASH -->
    <div class="state" id="state"></div>
    <div class="flash" id="flash"></div>

    <!-- SPRITE : un seul conteneur SVG pour superposer FX + <image> du perso -->
    <div class="stage">
      <svg class="sprite wobble" viewBox="0 0 200 200" id="sprite" aria-label="Cacamochi">
        <!-- Ombre au sol -->
        <ellipse cx="100" cy="170" rx="60" ry="12" fill="var(--shadow)"/>
        <!-- Image du perso selon Ã©volution -->
        <image id="evo-img" href="" x="0" y="0" width="200" height="200" preserveAspectRatio="xMidYMid meet"/>
        <!-- Vapeur -->
        <g class="steam" id="steam" stroke="#8a6e3a" stroke-width="2" opacity=".6">
          <line x1="60" y1="70" x2="60" y2="46"/>
          <line x1="100" y1="60" x2="100" y2="36"/>
          <line x1="140" y1="70" x2="140" y2="46"/>
        </g>
        <!-- Mouches dÃ©cor -->
        <g class="flies" id="flies" opacity=".9">
          <g transform="translate(100,105)">
            <g transform="rotate(0) translate(46,0)"><circle cx="0" cy="0" r="3" fill="#2a2a2a"/></g>
            <g transform="rotate(140) translate(46,0)"><circle cx="0" cy="0" r="3" fill="#2a2a2a"/></g>
          </g>
        </g>
      </svg>
    </div>

    <!-- ACTIONS -->
    <div class="actions">
      <button id="feed">ğŸ— Nourrir</button>
      <button id="play">ğŸ² Jouer</button>
      <button id="wash">ğŸ§¼ Laver</button>
      <button id="sleep">ğŸŒ™ Dodo</button>
      <button id="pet">ğŸ¤² Caresser</button>
      <button id="deodorize">ğŸŒ¬ï¸ DÃ©sodoriser</button>
      <button id="mystery">ğŸ Snack mystÃ¨re</button>
      <button id="hunt">ğŸª° Chasseâ€‘mouches</button>
      <button id="save">ğŸ’¾ Sauver</button>
      <button id="reset">ğŸ—‘ï¸ Repartir</button>
    </div>

    <!-- Minigame -->
    <div class="modal" id="modal">
      <div class="panel">
        <button class="close" id="close">âœ–</button>
        <h2>Chasseâ€‘mouches â€” 20â€¯s ! <span class="score" id="score">0</span></h2>
        <div class="arena" id="arena"></div>
      </div>
    </div>
  </main>

  <footer><span style="font-size:12px;opacity:.75">Tout est local (localStorage). DÃ©pose tes images dans /img et ajuste CONFIG.</span></footer>
</div>

<script>
(()=> {
  /* ===========================
     CONFIG â€” Ã€ ADAPTER SEULEMENT ICI
     =========================== */
  const CONFIG = {
    background: "img/background.jpg",
    sprites: {
      bouseau:   { src: "img/bouseau.png",   x:0,y:0,w:200,h:200 },
      cacabra:   { src: "img/cacabra.png",   x:0,y:0,w:200,h:200 },
      seigneur:  { src: "img/seigneur.png",  x:0,y:0,w:200,h:200 },
      skatour:   { src: "img/skatour.png",   x:0,y:0,w:200,h:200 },
      skalibur:  { src: "img/skalibur.png",  x:0,y:0,w:200,h:200 },
      crottombe: { src: "img/crottombe.png", x:0,y:0,w:200,h:200 },
      thanabouse:{ src: "img/thanabouse.png",x:0,y:0,w:200,h:200 },
    }
  };

  /* ====== rien Ã  changer sous cette ligne ====== */
  const $ = (s, r=document)=> r.querySelector(s);
  const app = {
    hunger:70, fun:70, hyg:70, energy:70,
    day:1, alive:true, asleep:false,
    evo:"bouseau",
    affection:0, discipline:0, odor:0
  };

  // refs
  const bar = {
    hunger: $("#bHunger .meter i"),
    fun: $("#bFun .meter i"),
    hyg: $("#bHyg .meter i"),
    energy: $("#bEnergy .meter i"),
  };
  const bars = { hunger:$("#bHunger"), fun:$("#bFun"), hyg:$("#bHyg"), energy:$("#bEnergy") };
  const age=$("#age"), state=$("#state"), flashEl=$("#flash");
  const sprite=$("#sprite"), steam=$("#steam"), flies=$("#flies");
  const evoImg=$("#evo-img"); const bg=$("#bg");
  const traitsEls={aff:$("#tAff"), dis:$("#tDis"), odo:$("#tOdo")};

  const evoName = id => ({bouseau:"Bouseau",cacabra:"Cacabra",seigneur:"SeignÅ“ur",skatour:"Skatour",skalibur:"Skalibur",crottombe:"Crottombe",thanabouse:"Thanabouse"}[id]||"???");

  // assets
  function applyBackground(){ if(CONFIG.background) bg.src = CONFIG.background; }
  function applySprite(){
    const s = CONFIG.sprites[app.evo];
    if(!s){ console.warn("Sprite manquant pour", app.evo); return; }
    evoImg.setAttribute("href", s.src);
    evoImg.setAttribute("x", s.x ?? 0);
    evoImg.setAttribute("y", s.y ?? 0);
    evoImg.setAttribute("width", s.w ?? 200);
    evoImg.setAttribute("height", s.h ?? 200);
  }

  // persistence
  const load=()=>{ try{const saved=JSON.parse(localStorage.getItem("cacamochi-img")); if(saved) Object.assign(app,saved);}catch(e){} };
  const save=()=>{ localStorage.setItem("cacamochi-img", JSON.stringify(app)); flash("SauvÃ© !"); };

  // UI
  function setMeter(name,val){
    val=Math.max(0,Math.min(100,val));
    bar[name].style.width=val+"%";
    bars[name].classList.toggle('bad',val<35);
    bars[name].classList.toggle('mid',val>=35&&val<65);
    bars[name].classList.toggle('good',val>=65);
    app[name]=val;
  }
  function setTrait(name,delta,min=-999,max=999){ app[name]=Math.max(min,Math.min(max,app[name]+delta)); }
  function avg(...xs){return xs.reduce((a,b)=>a+b,0)/xs.length;}
  function flash(txt){ const el=document.createElement('span'); el.className="label"; el.textContent=txt; state.appendChild(el); setTimeout(()=>el.remove(),1600); }
  function boom(){ flashEl.classList.add('on'); sprite.classList.add('shake'); setTimeout(()=>{flashEl.classList.remove('on');sprite.classList.remove('shake');},620); }
  function updateAll(){
    setMeter('hunger',app.hunger); setMeter('fun',app.fun); setMeter('hyg',app.hyg); setMeter('energy',app.energy);
    traitsEls.aff.textContent="Affection: "+app.affection;
    traitsEls.dis.textContent="Discipline: "+app.discipline;
    traitsEls.odo.textContent="Odeur: "+app.odor;
    steam.style.opacity=(1-app.hyg/100)*0.9+0.1;
    flies.style.opacity=(1-app.hyg/100)*0.9+0.1;
    age.textContent=`Jour ${app.day} â€” ${evoName(app.evo)}`;
    applySprite();
  }

  // actions (identiques v2)
  $("#feed").addEventListener('click',()=>{ if(!app.alive) return;
    setMeter('hunger',app.hunger+22); setMeter('hyg',app.hyg-6); setMeter('energy',app.energy+6);
    setTrait('affection',+1); setTrait('odor',+1);
    sprite.classList.add('happy'); setTimeout(()=>sprite.classList.remove('happy'),620); updateAll();
  });
  $("#play").addEventListener('click',()=>{ if(!app.alive) return;
    setMeter('fun',app.fun+18); setMeter('energy',app.energy-10); setMeter('hyg',app.hyg-7);
    setTrait('discipline',+1); setTrait('odor',+1);
    sprite.classList.add('happy'); setTimeout(()=>sprite.classList.remove('happy'),620); updateAll();
  });
  $("#wash").addEventListener('click',()=>{ if(!app.alive) return;
    setMeter('hyg',app.hyg+30); setTrait('odor',-3);
    sprite.classList.add('wash'); setTimeout(()=>sprite.classList.remove('wash'),2100); updateAll();
  });
  $("#sleep").addEventListener('click',()=>{ if(!app.alive) return; app.asleep=!app.asleep; flash(app.asleep?"Bonne nuit...":"RÃ©veil !"); updateAll(); });
  $("#deodorize").addEventListener('click',()=>{ if(!app.alive) return; setTrait('odor',-5); setMeter('hyg',app.hyg+6); flash("Pschhhâ€¯!"); updateAll(); });
  $("#mystery").addEventListener('click',()=>{ if(!app.alive) return;
    const r=Math.random(); if(r<.34){ setMeter('fun',app.fun+20); setTrait('affection',+2); flash("ğŸˆ Surprise joyeuse !"); }
    else if(r<.67){ setMeter('hyg',app.hyg-15); setTrait('odor',+4); flash("ğŸ¤¢ Beurk..."); }
    else { setMeter('energy',app.energy+18); setTrait('discipline',-1); flash("âš¡ Boost dâ€™Ã©nergie !"); } updateAll();
  });

  // caresser (drag)
  (()=>{ let pet=false, lastY=0, score=0, t=null;
    const start=y=>{ pet=true; lastY=y; score=0; t=setTimeout(()=>{ flash("ğŸ¤² +Affection"); setTrait('affection',+2); setMeter('fun',app.fun+6); updateAll(); },800); };
    const move=y=>{ if(!pet) return; if(Math.abs(y-lastY)>10){ score++; lastY=y; } };
    const end=()=>{ if(!pet) return; pet=false; if(t) clearTimeout(t); if(score>6){ setTrait('affection',+1); setMeter('fun',app.fun+4); updateAll(); } };
    sprite.addEventListener('mousedown',e=>start(e.clientY)); sprite.addEventListener('mousemove',e=>move(e.clientY)); window.addEventListener('mouseup',end);
    sprite.addEventListener('touchstart',e=>start(e.touches[0].clientY),{passive:true}); sprite.addEventListener('touchmove',e=>move(e.touches[0].clientY),{passive:true}); window.addEventListener('touchend',end);
    $("#pet").addEventListener('click',()=>flash("Astuceâ€¯: cliqueâ€‘glisse sur le Cacamochi pour le caresser."));
  })();

  // Minigame
  const modal=$("#modal"), arena=$("#arena"), scoreEl=$("#score"); let mgTimer=null, mgTtl=0, mgScore=0;
  function spawnFly(){ const f=document.createElement('div'); f.className="fly";
    const x=Math.random()*(arena.clientWidth-26), y=Math.random()*(arena.clientHeight-20);
    f.style.left=x+"px"; f.style.top=y+"px"; const life=800+Math.random()*1000;
    f.addEventListener('click',()=>{ mgScore++; scoreEl.textContent=mgScore; f.remove(); });
    arena.appendChild(f); setTimeout(()=>f.remove(),life);
  }
  function startHunt(){ modal.classList.add('on'); mgScore=0; scoreEl.textContent="0"; mgTtl=20; arena.innerHTML="";
    mgTimer=setInterval(()=>{ if(mgTtl<=0){ endHunt(); return; } mgTtl--; for(let i=0;i<1+Math.floor(Math.random()*3);i++) spawnFly(); },1000);
  }
  function endHunt(){ clearInterval(mgTimer); mgTimer=null; setTimeout(()=>{ modal.classList.remove('on'); arena.innerHTML=""; rewardHunt(); },600); }
  function rewardHunt(){ const s=mgScore;
    if(s>=20){ setMeter('fun',app.fun+24); setTrait('discipline',+4); flash("ğŸ… MaÃ®tre moucheur !"); }
    else if(s>=10){ setMeter('fun',app.fun+16); setTrait('discipline',+2); flash("ğŸ‘ Bonne chasse !"); }
    else { setMeter('fun',app.fun+8); setTrait('discipline',+1); flash("ğŸ‘ Pas mal."); }
    setTrait('odor',-2); updateAll();
  }
  $("#hunt").addEventListener('click',()=>{ if(app.alive) startHunt(); });
  $("#close").addEventListener('click',()=>{ modal.classList.remove('on'); if(mgTimer){clearInterval(mgTimer); mgTimer=null;} });

  // Random events
  setInterval(()=>{ if(!app.alive) return;
    const r=Math.random();
    if(r<.18){ flash("Une mouche sâ€™est posÃ©e..."); setMeter('hyg',app.hyg-4); setTrait('odor',+1); updateAll(); }
    else if(r<.28){ flash("Petit rot discret."); setMeter('hunger',app.hunger+3); setTrait('odor',+1); updateAll(); }
  }, 30000);

  // Time & evolution
  function tick(){ if(!app.alive) return;
    const k=app.asleep?0.45:1;
    setMeter('hunger',app.hunger-0.6*k); setMeter('fun',app.fun-0.45*k); setMeter('hyg',app.hyg-0.35*k); setMeter('energy',app.energy-(app.asleep?-0.9:0.7));
    if(['hunger','fun','hyg','energy'].filter(x=>app[x]<=0).length>=2){ app.alive=false; flash("ğŸ’€ RIP Cacamochi..."); disableActions(true); }
    $("#sprite .flies").style.animationDuration=(5+Math.random()*3).toFixed(1)+"s";
    updateAll();
  }
  function newDay(){ if(!app.alive) return; app.day++; flash("â˜€ï¸ Jour "+app.day);
    setMeter('hyg',app.hyg-5); setMeter('hunger',app.hunger-6); evolveCheck(); save(); updateAll();
  }
  setInterval(tick,1200); setInterval(newDay, 1.2*60*1000);

  function evolveCheck(){
    const avg=(...x)=>x.reduce((a,b)=>a+b,0)/x.length;
    const mood=avg(app.hunger,app.fun,app.hyg,app.energy);
    const clean=app.hyg - app.odor*1.5;
    const playful=app.fun + app.affection;
    const stoic=app.energy - app.discipline*0.5;
    if(app.day>=2 && app.evo==="bouseau"){
      if(clean>=60 && playful>=60) evolveTo("cacabra");
      else if(playful>=65 && clean<60) evolveTo("skatour");
      else if(stoic<45) evolveTo("crottombe");
    }
    if(app.day>=4){
      if(app.evo==="cacabra"   && mood>78 && app.discipline>=4) evolveTo("seigneur");
      if(app.evo==="skatour"   && playful>80)                  evolveTo("skalibur");
      if(app.evo==="crottombe" && (clean<45 || app.energy<40)) evolveTo("thanabouse");
    }
  }
  function evolveTo(next){ if(app.evo===next) return; app.evo=next; boom(); flash(`âœ¨ Ã‰volution : ${evoName(next)} !`); applySprite(); }

  function disableActions(dis){ ["feed","play","wash","sleep","pet","deodorize","mystery","hunt","save"].forEach(id=>$("#"+id).disabled=dis); }

  // init
  applyBackground(); load(); updateAll();
  $("#save").addEventListener('click',save);
  $("#reset").addEventListener('click',()=>{ localStorage.removeItem("cacamochi-img"); Object.assign(app,{
    hunger:70,fun:70,hyg:70,energy:70,day:1,alive:true,asleep:false,evo:"bouseau",affection:0,discipline:0,odor:0
  }); disableActions(false); flash("Nouveau dÃ©part !"); updateAll(); });
})();
</script>
</body>
</html>
