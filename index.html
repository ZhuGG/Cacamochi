<script>
/* ===== Mini‑jeu MOUCHES — Arcade v3.1 (spawns cadencés) ===== */
(function(){
  const modal   = document.getElementById('modalFlies');
  const arena   = document.getElementById('arenaFlies');
  const scoreEl = document.getElementById('scoreFlies');
  const btnOpen = document.getElementById('btnFlies');
  const btnClose= document.getElementById('closeFlies');

  const A = {
    small:"img/flies/fly_small.png",
    big  :"img/flies/fly_big.png",
    gold :"img/flies/fly_gold.png",
    splat:"img/flies/splat.png",
    spark:"img/flies/spark.png" /* optionnel */
  };

  let RAF=0, running=false, startTs=0, score=0, timeLeft=20;
  const flies=[]; let spawnTimer=0;

  function resetArenaSizes(){ return new Promise(r=>requestAnimationFrame(()=>r())); }

  function spawnOne(){
    const w = arena.clientWidth, h = arena.clientHeight;
    const img = document.createElement('img');
    const r = Math.random();
    let type='small', speed=55, hp=1, pts=1, src=A.small;

    if(r>0.8){ type='big';  speed=42; hp=2; pts=2; src=A.big;  }
    if(r<0.10){ type='gold'; speed=75; hp=1; pts=5; src=A.gold; }

    img.src=src; img.className='fly '+type; img.draggable=false;
    arena.appendChild(img);

    const f = {
      el:img,
      x:Math.random()*w, y:Math.random()*h,
      vx:(Math.random()*2-1)*speed,
      vy:(Math.random()*2-1)*speed,
      t:0, hp, pts, dead:false
    };

    const hit = (ev)=>{
      ev.stopPropagation();
      f.hp--;
      pop(f.x, f.y, f.hp<=0, type==='gold');
      if(f.hp<=0){ f.dead=true; score+=f.pts; scoreEl.textContent=score; img.remove(); }
    };
    img.addEventListener('mousedown',hit);
    img.addEventListener('touchstart',hit,{passive:true});

    flies.push(f);
  }

  function pop(x,y,dead,gold){
    const fx=document.createElement('img');
    fx.src = dead?A.splat:(A.spark||A.splat);
    fx.className = dead?'sfx splat':'sfx spark';
    fx.style.left=x+'px'; fx.style.top=y+'px';
    arena.appendChild(fx); setTimeout(()=>fx.remove(), dead?380:600);

    if(gold && A.spark){
      const fx2=document.createElement('img');
      fx2.src=A.spark; fx2.className='sfx spark';
      fx2.style.left=(x+10)+'px'; fx2.style.top=(y-10)+'px';
      arena.appendChild(fx2); setTimeout(()=>fx2.remove(),600);
    }
  }

  function mainLoop(ts){
    if(!running) return;
    if(!startTs) startTs = ts;
    const dt = Math.min(32, ts - (mainLoop._prev||ts)); mainLoop._prev = ts;

    const w=arena.clientWidth, h=arena.clientHeight;

    // Mouvement + rebond
    for(const f of flies){
      if(f.dead) continue;
      f.t += dt;
      if(f.t>400){ f.vx += (Math.random()*2-1)*22; f.vy += (Math.random()*2-1)*22; f.t=0; }
      f.x += f.vx*dt/1000; f.y += f.vy*dt/1000;
      if(f.x<12||f.x>w-12) f.vx*=-1;
      if(f.y<12||f.y>h-12) f.vy*=-1;
      f.el.style.transform = `translate(${f.x}px,${f.y}px)`;
    }

    // Fin de partie
    const elapsed = (ts - startTs) / 1000;
    if(elapsed >= 20){ stop(true); return; }

    RAF = requestAnimationFrame(mainLoop);
  }

  function cadenceSpawn(){
    // spawn régulier (toutes les 600–800 ms), avec plafond souple
    if(!running) return;
    const aliveCount = flies.filter(f=>!f.dead).length;
    const max = 10;
    if(aliveCount < max) spawnOne();
    spawnTimer = setTimeout(cadenceSpawn, 600 + Math.random()*200);
  }

  function start(){
    score=0; scoreEl.textContent='0'; timeLeft=20;
    startTs=0; mainLoop._prev=0;
    flies.splice(0,flies.length);

    modal.classList.add('on'); running=true;
    resetArenaSizes().then(()=>{
      for(let i=0;i<6;i++) spawnOne();
      cadenceSpawn();
      RAF = requestAnimationFrame(mainLoop);
    });
  }

  function stop(reward){
    running=false; cancelAnimationFrame(RAF); clearTimeout(spawnTimer);
    flies.forEach(f=>f.el && f.el.remove()); flies.length=0;
    setTimeout(()=>modal.classList.remove('on'),150);

    if(reward){
      const s=score;
      if(s>=24){ setMeter('fun',app.fun+24); setTrait('discipline',+4); setTrait('odor',-2); say("Maître moucheur !"); }
      else if(s>=12){ setMeter('fun',app.fun+16); setTrait('discipline',+2); setTrait('odor',-2); say("Bonne chasse !"); }
      else { setMeter('fun',app.fun+8); setTrait('discipline',+1); setTrait('odor',-1); say("Pas mal."); }
      updateAll(); save();
    }
  }

  btnOpen.addEventListener('click', ()=> app.alive && start());
  btnClose.addEventListener('click', ()=> stop(false));
  modal.addEventListener('click', e=>{ if(e.target===modal) stop(false); });
})();
</script>
