<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Cacamochi â€” Final Fix</title>
<style>
  :root{
    --rose:#f7e4e1; --rose-2:#f3d5cf; --rose-3:#eec0b6;
    --marron:#8e5f48; --marron-dark:#5d3d30;
    --txt:#2a1d16; --glass:#ffffffd8; --shadow:#00000028;
    --good:#5cc66a; --mid:#ffb84d; --bad:#ff6565;
    --btn:#ffe7e2; --btnOn:#ffd2c7; --icon:#7c5542;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--rose);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .app{min-height:100%;display:grid;grid-template-rows:auto 1fr}

  /* Header */
  header{display:flex;align-items:center;gap:.7rem;padding:.7rem .9rem;background:linear-gradient(180deg,var(--rose-2),var(--rose))}
  header h1{margin:0;font-size:1.05rem}
  .age{margin-left:auto;background:var(--glass);backdrop-filter:blur(6px);padding:.25rem .6rem;border-radius:999px;box-shadow:0 2px 6px var(--shadow);font-weight:700;font-size:.85rem}

  /* Stage */
  .stage{position:relative;overflow:hidden}
  .bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:contrast(1.03) brightness(1.02)}
  .center{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
  .sprite{width:clamp(180px,48vw,340px);pointer-events:auto;filter:drop-shadow(0 16px 12px var(--shadow));touch-action:none}
  .wobble{animation:wobble 2.4s ease-in-out infinite}
  @keyframes wobble{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-3%) scale(1.02)}}
  .wash{animation:wash .7s ease-in-out 3}@keyframes wash{0%{filter:hue-rotate(0)}50%{filter:hue-rotate(90deg) saturate(1.2)}100%{filter:hue-rotate(0)}}
  .dance{animation:dance .7s ease-in-out 4}@keyframes dance{0%{transform:translateX(0) rotate(0)}25%{transform:translateX(-8%) rotate(-6deg)}50%{transform:translateX(0) rotate(0)}75%{transform:translateX(8%) rotate(6deg)}100%{transform:translateX(0) rotate(0)}}

  /* HUD */
  .hud{position:absolute;top:.6rem;left:50%;transform:translateX(-50%);width:min(94vw,560px);
       display:grid;grid-template-columns:1fr 1fr;gap:.6rem;background:var(--glass);backdrop-filter:blur(8px);
       padding:.6rem;border-radius:18px;box-shadow:0 6px 22px var(--shadow);z-index:5}
  .bar h3{margin:0 0 .28rem 0;font-size:.9rem}
  .meter{height:10px;background:#00000015;border-radius:99px;overflow:hidden}
  .meter>i{display:block;height:100%;width:50%;background:linear-gradient(90deg,var(--good),#9ee68b);transition:width .26s}
  .bad>i{background:linear-gradient(90deg,var(--bad),#ff8080)}
  .mid>i{background:linear-gradient(90deg,var(--mid),#ffd197)}
  .chips{position:absolute;top:calc(.6rem + 98px);left:50%;transform:translateX(-50%);
         display:flex;gap:.4rem;flex-wrap:wrap;max-width:94vw;justify-content:center;z-index:5}
  .chip{background:var(--glass);backdrop-filter:blur(6px);padding:.3rem .6rem;border-radius:999px;font-size:.82rem;box-shadow:0 2px 6px var(--shadow)}

  /* Odeur/mouches du sprite */
  .steam line{animation:steam 3.4s ease-in-out infinite}
  @keyframes steam{0%{opacity:0;transform:translateY(8px)}20%{opacity:.9}100%{opacity:0;transform:translateY(-26px)}}
  .orbitFlies{animation:orbit 6s linear infinite;transform-origin:center}
  @keyframes orbit{from{transform:rotate(0)}to{transform:rotate(360deg)}}

  /* Nuit */
  .sleepOverlay{position:absolute;inset:0;pointer-events:none;opacity:0;transition:opacity .35s;z-index:3}
  .sleeping .sleepOverlay{opacity:1}
  .sleepOverlay .tint{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 60%,#143a6a33 0%,#0822458a 60%,#061a3666 100%)}
  .stars{position:absolute;inset:0;overflow:hidden}
  .star{position:absolute;width:3px;height:3px;background:#d8e7ff;border-radius:50%;opacity:.9;animation:tw 2.2s ease-in-out infinite}
  @keyframes tw{0%,100%{transform:scale(1)}50%{transform:scale(1.6)}}
  .zzz{position:absolute;left:50%;top:38%;transform:translateX(-50%);font:700 18px/1.2 monospace;color:#cfe3ff;animation:zzz 2.6s ease-in-out infinite}
  @keyframes zzz{0%{opacity:0;transform:translate(-50%,6px)}25%{opacity:1}100%{opacity:0;transform:translate(-50%,-18px)}}

  /* Bulles de notification */
  .speech{position:absolute;left:50%;top:22%;transform:translateX(-50%);z-index:6;pointer-events:none}
  .speech .b{background:var(--glass);backdrop-filter:blur(8px);padding:.5rem .7rem;border-radius:14px;box-shadow:0 6px 18px var(--shadow);font-weight:800}
  .speech .t{width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:10px solid var(--glass);margin:auto}

  /* Dock â€“ boutons ronds icÃ´ne + texte */
  .dock{position:absolute;left:50%;bottom:.7rem;transform:translateX(-50%);
        display:grid;grid-template-columns:repeat(6,1fr);gap:.55rem;z-index:10}
  .btn{width:72px;height:72px;border-radius:18px;border:none;background:var(--btn);
       box-shadow:0 8px 18px var(--shadow);display:flex;flex-direction:column;align-items:center;justify-content:center}
  .btn:active{transform:translateY(2px);background:var(--btnOn)}
  .ico{width:22px;height:22px;color:var(--icon);display:block}
  .lbl{margin-top:4px;font-size:.72rem;font-weight:800;color:var(--marron)}

  /* Miniâ€‘jeux: boutons sur la scÃ¨ne */
  .gameBtn{position:absolute;z-index:8;width:56px;height:56px;border-radius:50%;border:none;background:var(--btn);
           box-shadow:0 8px 18px var(--shadow);display:flex;flex-direction:column;align-items:center;justify-content:center}
  .gameBtn .ico{width:22px;height:22px}
  .gameBtn .lbl{font-size:.7rem;margin-top:2px}
  .gameBtn.bath{right:.8rem;top:48%}
  .gameBtn.flies{left:.8rem;top:48%}

  /* Modals (jeux) */
  .modal{position:absolute;inset:0;background:#00000070;display:none;align-items:center;justify-content:center;z-index:20}
  .modal.on{display:flex}
  .panelMG{width:min(520px,92vw);height:min(420px,80vh);background:#fff6f4;border-radius:16px;box-shadow:0 10px 30px #00000040;position:relative;overflow:hidden;border:3px solid var(--rose-3)}
  .panelHead{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;gap:8px}
  .panelHead h2{margin:0;font-size:16px}
  .panelHead .score{font-weight:800}
  .close{border:none;background:#0000;font-size:18px;line-height:1;cursor:pointer}
  .arena{position:absolute;inset:56px 12px 14px 12px;border-radius:12px;overflow:hidden}
  .arena.bath{background:#f6eaf0}
  .arena.flygame{background:#eaf7e6}
  .bubble{position:absolute;width:34px;height:34px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #ffffffaa 0%, #ffd6f3 40%, #ffc1ea 70%, #f5a7d5 100%);box-shadow:0 2px 6px #00000033}
  .fly{position:absolute;width:26px;height:20px}
  .fly::after{content:"ðŸª°";font-size:20px;line-height:20px}
</style>
</head>
<body>

<!-- SPRITE Dâ€™ICÃ”NES -->
<svg aria-hidden="true" width="0" height="0" style="position:absolute;left:-9999px;top:-9999px;">
  <symbol id="i-food" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3v8M8 3v8M6 7h2"/><path d="M14 3a3 3 0 0 1 3 3v5a2 2 0 0 1-2 2h-1V3z"/></g></symbol>
  <symbol id="i-soap" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c-3 4-6 6-6 9a6 6 0 0 0 12 0c0-3-3-5-6-9z"/><path d="M18.5 5.5l1 1m-3 0l1-1"/></g></symbol>
  <symbol id="i-toilet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="7" width="14" height="10" rx="4"/><circle cx="7" cy="12" r="2"/><path d="M17 7h2a2 2 0 0 1 2 2v8"/></g></symbol>
  <symbol id="i-moon" viewBox="0 0 24 24"><path d="M20 15a8 8 0 1 1-6-12a7 7 0 0 0 6 12z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
  <symbol id="i-play" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="3"/></g><circle cx="10" cy="10" r="1.6" fill="currentColor"/><circle cx="14" cy="14" r="1.6" fill="currentColor"/></symbol>
  <symbol id="i-heal" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="8"/><path d="M12 8v8M8 12h8"/></g></symbol>
  <symbol id="i-bubbles" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="12" r="3"/><circle cx="14.5" cy="10.5" r="2.2"/><circle cx="18" cy="8" r="1.5"/></g></symbol>
  <symbol id="i-flies" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="8" height="8" rx="1"/><path d="M8 12l8 8"/><path d="M6.5 6.5h3m-3 2h3m-3 2h3"/></g></symbol>
</svg>

<div class="app" id="app">
  <header>
    <h1>ðŸ’© Cacamochi</h1>
    <div class="age" id="age">Jour 1 â€” Bouseau</div>
  </header>

  <main class="stage" id="room">
    <img id="bg" class="bg" alt="PiÃ¨ce" src=""/>

    <div class="hud">
      <div class="bar" id="bHunger"><h3>Faim</h3><div class="meter"><i></i></div></div>
      <div class="bar" id="bFun"><h3>Fun</h3><div class="meter"><i></i></div></div>
      <div class="bar" id="bHyg"><h3>HygiÃ¨ne</h3><div class="meter"><i></i></div></div>
      <div class="bar" id="bEnergy"><h3>Ã‰nergie</h3><div class="meter"><i></i></div></div>
    </div>
    <div class="chips">
      <span class="chip" id="tAff">Affection: 0</span>
      <span class="chip" id="tDis">Discipline: 0</span>
      <span class="chip" id="tOdo">Odeur: 0</span>
    </div>

    <!-- Notifications -->
    <div class="speech" id="speech" style="display:none">
      <div class="b" id="speechText">Hi!</div><div class="t"></div>
    </div>

    <!-- Nuit -->
    <div class="sleepOverlay" id="sleepOverlay"><div class="tint"></div><div class="stars" id="stars"></div><div class="zzz">Z z z ...</div></div>

    <!-- Sprite -->
    <div class="center">
      <svg class="sprite wobble" viewBox="0 0 200 200" id="sprite" aria-label="Cacamochi">
        <ellipse cx="100" cy="170" rx="60" ry="12" fill="#00000022"/>
        <image id="evo-img" href="" x="0" y="0" width="200" height="200" preserveAspectRatio="xMidYMid meet"/>
        <g class="steam" id="steam" stroke="#8a6e3a" stroke-width="2" opacity=".6">
          <line x1="60" y1="70" x2="60" y2="46"/><line x1="100" y1="60" x2="100" y2="36"/><line x1="140" y1="70" x2="140" y2="46"/>
        </g>
        <g class="orbitFlies" id="orbitFlies" opacity=".9">
          <g transform="translate(100,105)">
            <g transform="rotate(0) translate(46,0)"><circle cx="0" cy="0" r="3" fill="#2a2a2a"/></g>
            <g transform="rotate(140) translate(46,0)"><circle cx="0" cy="0" r="3" fill="#2a2a2a"/></g>
          </g>
        </g>
      </svg>
    </div>

    <!-- Dock boutons ronds -->
    <div class="dock">
      <button type="button" class="btn" id="feed"><svg class="ico"><use href="#i-food"/></svg><span class="lbl">Nourrir</span></button>
      <button type="button" class="btn" id="wash"><svg class="ico"><use href="#i-soap"/></svg><span class="lbl">Laver</span></button>
      <button type="button" class="btn" id="toilet"><svg class="ico"><use href="#i-toilet"/></svg><span class="lbl">WC</span></button>
      <button type="button" class="btn" id="sleep"><svg class="ico"><use href="#i-moon"/></svg><span class="lbl">Dodo</span></button>
      <button type="button" class="btn" id="play"><svg class="ico"><use href="#i-play"/></svg><span class="lbl">Jouer</span></button>
      <button type="button" class="btn" id="heal"><svg class="ico"><use href="#i-heal"/></svg><span class="lbl">Soigner</span></button>
    </div>

    <!-- Miniâ€‘jeux: boutons flottants -->
    <button type="button" class="gameBtn bath"  id="btnBath"><svg class="ico"><use href="#i-bubbles"/></svg><span class="lbl">Bain</span></button>
    <button type="button" class="gameBtn flies" id="btnFlies"><svg class="ico"><use href="#i-flies"/></svg><span class="lbl">Mouches</span></button>

    <!-- Modals (2 jeux) -->
    <div class="modal" id="modalBath">
      <div class="panelMG">
        <div class="panelHead">
          <h2>Bain Mousse â€” 20â€¯s</h2>
          <div class="score" id="scoreBath">0</div>
          <button type="button" class="close" id="closeBath">âœ–</button>
        </div>
        <div class="arena bath" id="arenaBath"></div>
      </div>
    </div>
    <div class="modal" id="modalFlies">
      <div class="panelMG">
        <div class="panelHead">
          <h2>Chasseâ€‘mouches â€” 20â€¯s</h2>
          <div class="score" id="scoreFlies">0</div>
          <button type="button" class="close" id="closeFlies">âœ–</button>
        </div>
        <div class="arena flygame" id="arenaFlies"></div>
      </div>
    </div>
  </main>
</div>

<script>
(()=> {
  const CONFIG = {
    background: "img_background.jpg",
    sprites: {
      bouseau:   { src: "img_bouseau.png",   x:0,y:0,w:200,h:200 },
      cacabra:   { src: "img_cacabra.png",   x:0,y:0,w:200,h:200 },
      seigneur:  { src: "img_seigneur.png",  x:0,y:0,w:200,h:200 },
      skatour:   { src: "img_skatour.png",   x:0,y:0,w:200,h:200 },
      skalibur:  { src: "img_skalibur.png",  x:0,y:0,w:200,h:200 },
      crottombe: { src: "img_crottombe.png", x:0,y:0,w:200,h:200 },
      thanabouse:{ src: "img_thanabouse.png",x:0,y:0,w:200,h:200 }
    }
  };

  const $=(s,r=document)=>r.querySelector(s);
  const app={hunger:70,fun:70,hyg:70,energy:70,day:1,alive:true,asleep:false,
             evo:"bouseau",affection:0,discipline:0,odor:0,badgeSoap:false,badgeFly:false};

  // Refs
  const bar={ hunger:$("#bHunger .meter i"), fun:$("#bFun .meter i"), hyg:$("#bHyg .meter i"), energy:$("#bEnergy .meter i") };
  const bars={ hunger:$("#bHunger"), fun:$("#bFun"), hyg:$("#bHyg"), energy:$("#bEnergy") };
  const age=$("#age"), speech=$("#speech"), speechText=$("#speechText");
  const bg=$("#bg"), evoImg=$("#evo-img"), sprite=$("#sprite"), steam=$("#steam");
  const traitsEls={aff:$("#tAff"), dis:$("#tDis"), odo:$("#tOdo")};
  const stars=$("#stars");

  const evoName=id=>({bouseau:"Bouseau",cacabra:"Cacabra",seigneur:"SeignÅ“ur",skatour:"Skatour",skalibur:"Skalibur",crottombe:"Crottombe",thanabouse:"Thanabouse"}[id]||"???" );

  // Ã©toiles nuit
  for(let i=0;i<42;i++){ const s=document.createElement('div'); s.className='star'; s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%'; s.style.animationDelay=(Math.random()*2)+'s'; stars.appendChild(s); }

  function say(txt){ speechText.textContent=txt; speech.style.display='block'; clearTimeout(say.t); say.t=setTimeout(()=>speech.style.display='none',1400); }
  function applyBackground(){ bg.src=CONFIG.background; }
  function applySprite(){ const s=CONFIG.sprites[app.evo]; if(!s) return;
    evoImg.setAttribute('href',s.src); evoImg.setAttribute('x',s.x??0); evoImg.setAttribute('y',s.y??0);
    evoImg.setAttribute('width',s.w??200); evoImg.setAttribute('height',s.h??200);
  }

  function setMeter(name,val){ val=Math.max(0,Math.min(100,val)); bar[name].style.width=val+"%";
    bars[name].classList.toggle('bad',val<35); bars[name].classList.toggle('mid',val>=35&&val<65); bars[name].classList.toggle('good',val>=65); app[name]=val; }
  function setTrait(name,delta,min=-999,max=999){ app[name]=Math.max(min,Math.min(max,app[name]+delta)); }
  function avg(...xs){return xs.reduce((a,b)=>a+b,0)/xs.length;}
  function updateAll(){
    setMeter('hunger',app.hunger); setMeter('fun',app.fun); setMeter('hyg',app.hyg); setMeter('energy',app.energy);
    traitsEls.aff.textContent="Affection: "+app.affection; traitsEls.dis.textContent="Discipline: "+app.discipline; traitsEls.odo.textContent="Odeur: "+app.odor;
    age.textContent=`Jour ${app.day} â€” ${evoName(app.evo)}`; applySprite();
    document.body.classList.toggle('sleeping', app.asleep);
  }

  const load=()=>{ try{const s=JSON.parse(localStorage.getItem("cacamochi-v4lite")); if(s) Object.assign(app,s);}catch(e){} };
  const save=()=>{ localStorage.setItem("cacamochi-v4lite", JSON.stringify(app)); };

  // Actions (dock)
  $("#feed").addEventListener('click',()=>{ if(!app.alive) return;
    setMeter('hunger',app.hunger+22); setMeter('hyg',app.hyg-6); setMeter('energy',app.energy+6);
    setTrait('affection',+1); setTrait('odor',+1); say("Miam !"); updateAll(); save();
  });
  $("#wash").addEventListener('click',()=>{ if(!app.alive) return;
    setMeter('hyg',app.hyg+30); setTrait('odor',-3); sprite.classList.add('wash'); setTimeout(()=>sprite.classList.remove('wash'),2100); say("Tout propre !"); updateAll(); save();
  });
  $("#toilet").addEventListener('click',()=>{ if(!app.alive) return; setMeter('hyg',app.hyg+40); setTrait('odor',-6); say("ðŸ§» Fiuuut !"); updateAll(); save(); });
  $("#sleep").addEventListener('click',()=>{ if(!app.alive) return; app.asleep=!app.asleep; say(app.asleep?"Bonne nuit...":"RÃ©veil !"); updateAll(); save(); });
  $("#play").addEventListener('click',()=>{ if(!app.alive) return;
    setMeter('fun',app.fun+16); setMeter('energy',app.energy-8); setTrait('discipline',+1); setTrait('odor',+1); say("On joue !"); updateAll(); save();
  });
  $("#heal").addEventListener('click',()=>{ if(!app.alive) return;
    const low=['hunger','fun','hyg','energy'].some(k=>app[k]<35);
    if(low){ ['hunger','fun','hyg','energy'].forEach(k=>setMeter(k,app[k]+8)); say("ðŸ’Š Ã‡a va mieux."); } else say("Pas besoin.");
    updateAll(); save();
  });

  // Doubleâ€‘tap = Danse (sur sprite)
  (function doubleTapDance(){
    let last=0;
    sprite.addEventListener('touchend',()=>{ const now=Date.now(); if(now-last<300){ dance(); } last=now; },{passive:true});
    sprite.addEventListener('click',()=>{ const now=Date.now(); if(now-last<300){ dance(); } last=now; });
    function dance(){ if(!app.alive) return; sprite.classList.add('dance'); setTimeout(()=>sprite.classList.remove('dance'),2800);
      setMeter('fun',app.fun+10); setMeter('energy',app.energy-6); say("Disco !"); updateAll(); save(); }
  })();

  // Caresser (drag court)
  (function pet(){
    let pet=false, lastX=0,lastY=0, moves=0, timer=null;
    const start=(x,y)=>{ pet=true; lastX=x; lastY=y; moves=0;
      timer=setTimeout(()=>{ if(pet){ setTrait('affection',+2); setMeter('fun',app.fun+6); say("ðŸ¤² +Affection"); updateAll(); save(); } },700);
    };
    const move=(x,y)=>{ if(!pet) return; if(Math.abs(x-lastX)+Math.abs(y-lastY)>14){ moves++; lastX=x; lastY=y; } };
    const end=()=>{ if(!pet) return; pet=false; if(timer) clearTimeout(timer); if(moves>8){ setTrait('affection',+1); setMeter('fun',app.fun+4); say("Il adore !"); updateAll(); save(); } };
    const area=$("#sprite");
    area.addEventListener('touchstart',e=>{const t=e.touches[0]; start(t.clientX,t.clientY);},{passive:true});
    area.addEventListener('touchmove', e=>{const t=e.touches[0]; move(t.clientX,t.clientY);},{passive:true});
    window.addEventListener('touchend', end);
    area.addEventListener('mousedown',e=>start(e.clientX,e.clientY));
    area.addEventListener('mousemove',e=>move(e.clientX,e.clientY));
    window.addEventListener('mouseup',end);
  })();

  /* ---------------- Jeux ---------------- */
  // Bain
  const modalBath=$("#modalBath"), arenaBath=$("#arenaBath"), scoreBath=$("#scoreBath");
  let tBath=null, scBath=0, timeBath=20;
  function spawnBubble(){ const f=document.createElement('div'); f.className="bubble";
    const x=Math.random()*(arenaBath.clientWidth-34), y=arenaBath.clientHeight+20; f.style.left=x+"px"; f.style.top=y+"px";
    const dur=1200+Math.random()*1200; const start=performance.now();
    function step(t){ const p=(t-start)/dur; if(p>=1){ f.remove(); return; } f.style.top=(y - p*(arenaBath.clientHeight+80))+"px"; requestAnimationFrame(step); }
    const add=()=>{ scBath++; scoreBath.textContent=scBath; f.remove(); };
    f.addEventListener('click',add); f.addEventListener('touchstart',add,{passive:true});
    arenaBath.appendChild(f); requestAnimationFrame(step);
  }
  function startBath(){ modalBath.classList.add('on'); arenaBath.innerHTML=""; scBath=0; scoreBath.textContent="0"; timeBath=20;
    tBath=setInterval(()=>{ if(timeBath<=0){ endBath(); return; } timeBath--; for(let i=0;i<2+Math.floor(Math.random()*3);i++) spawnBubble(); },1000); }
  function endBath(){ clearInterval(tBath); tBath=null; setTimeout(()=>{ modalBath.classList.remove('on'); arenaBath.innerHTML=""; rewardBath(); },400); }
  function rewardBath(){ const s=scBath;
    if(s>=25){ setMeter('hyg',app.hyg+30); setMeter('fun',app.fun+18); setTrait('odor',-4); say("ðŸ«§ Roi de la mousse !"); }
    else if(s>=12){ setMeter('hyg',app.hyg+20); setMeter('fun',app.fun+12); setTrait('odor',-3); say("ðŸ«§ Bien jouÃ© !"); }
    else { setMeter('hyg',app.hyg+12); setMeter('fun',app.fun+6); setTrait('odor',-2); say("ðŸ«§ Pas mal."); }
    updateAll(); save();
  }
  $("#btnBath").addEventListener('click',()=>{ if(app.alive) startBath(); });
  $("#closeBath").addEventListener('click',()=>{ modalBath.classList.remove('on'); if(tBath){clearInterval(tBath); tBath=null;} });

  // Mouches (nouveau namespace: flygame)
  const modalFlies=$("#modalFlies"), arenaFlies=$("#arenaFlies"), scoreFlies=$("#scoreFlies");
  let tFly=null, scFly=0, timeFly=20;
  function spawnFly(){ const f=document.createElement('div'); f.className="fly";
    const x=Math.random()*(arenaFlies.clientWidth-26), y=Math.random()*(arenaFlies.clientHeight-20);
    f.style.left=x+"px"; f.style.top=y+"px";
    const life=800+Math.random()*1000, killer=()=>{ scFly++; scoreFlies.textContent=scFly; f.remove(); };
    f.addEventListener('click',killer); f.addEventListener('touchstart',killer,{passive:true});
    arenaFlies.appendChild(f); setTimeout(()=>f.remove(),life);
  }
  function startFlies(){ modalFlies.classList.add('on'); arenaFlies.innerHTML=""; scFly=0; scoreFlies.textContent="0"; timeFly=20;
    tFly=setInterval(()=>{ if(timeFly<=0){ endFlies(); return; } timeFly--; const n=1+Math.floor(Math.random()*3); for(let i=0;i<n;i++) spawnFly(); },1000); }
  function endFlies(){ clearInterval(tFly); tFly=null; setTimeout(()=>{ modalFlies.classList.remove('on'); arenaFlies.innerHTML=""; rewardFlies(); },400); }
  function rewardFlies(){ const s=scFly;
    if(s>=20){ setMeter('fun',app.fun+24); setTrait('discipline',+4); setTrait('odor',-2); say("MaÃ®tre moucheur !"); }
    else if(s>=10){ setMeter('fun',app.fun+16); setTrait('discipline',+2); setTrait('odor',-2); say("Bonne chasse !"); }
    else { setMeter('fun',app.fun+8); setTrait('discipline',+1); setTrait('odor',-1); say("Pas mal."); }
    updateAll(); save();
  }
  $("#btnFlies").addEventListener('click',()=>{ if(app.alive) startFlies(); });
  $("#closeFlies").addEventListener('click',()=>{ modalFlies.classList.remove('on'); if(tFly){clearInterval(tFly); tFly=null;} });

  // Random & time
  setInterval(()=>{ if(!app.alive) return; const r=Math.random();
    if(r<.18){ say("Une mouche sâ€™est posÃ©e..."); setMeter('hyg',app.hyg-4); setTrait('odor',+1); updateAll(); }
    else if(r<.28){ say("Petit rot discret."); setMeter('hunger',app.hunger+3); setTrait('odor',+1); updateAll(); }
  }, 30000);

  function tick(){ if(!app.alive) return;
    const k=app.asleep?0.45:1;
    setMeter('hunger',app.hunger-0.6*k); setMeter('fun',app.fun-0.45*k); setMeter('hyg',app.hyg-0.35*k);
    setMeter('energy', app.energy-(app.asleep?-0.9:0.7));
    if(['hunger','fun','hyg','energy'].filter(x=>app[x]<=0).length>=2){ app.alive=false; say("ðŸ’€ RIP Cacamochi..."); }
    updateAll();
  }
  function newDay(){ if(!app.alive) return; app.day++; say("â˜€ï¸ Jour "+app.day);
    setMeter('hyg',app.hyg-5); setMeter('hunger',app.hunger-6);
    evolveCheck(); save(); updateAll();
  }
  setInterval(tick,1200); setInterval(newDay, 1.2*60*1000);

  function evolveCheck(){
    const mood=avg(app.hunger,app.fun,app.hyg,app.energy);
    const clean=app.hyg - app.odor*1.5, playful=app.fun + app.affection, stoic=app.energy - app.discipline*0.5;
    if(app.day>=2 && app.evo==="bouseau"){
      if(clean>=60 && playful>=60) evolveTo("cacabra");
      else if(playful>=65 && clean<60) evolveTo("skatour");
      else if(stoic<45) evolveTo("crottombe");
    }
    if(app.day>=4){
      if(app.evo==="cacabra"   && mood>78 && app.discipline>=4) evolveTo("seigneur");
      if(app.evo==="skatour"   && playful>80)                  evolveTo("skalibur");
      if(app.evo==="crottombe" && (clean<45 || app.energy<40)) evolveTo("thanabouse");
    }
  }
  function evolveTo(next){ if(app.evo===next) return; app.evo=next; say(`âœ¨ Ã‰volution : ${evoName(next)} !`); applySprite(); }

  // Init
  applyBackground(); load(); updateAll();
})();
</script>
</body>
</html>
